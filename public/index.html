<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%23667eea'/><stop offset='100%25' style='stop-color:%23764ba2'/></linearGradient></defs><circle cx='50' cy='50' r='45' fill='url(%23g)'/><path d='M50 25 L35 35 L35 50 Q35 65 50 70 Q65 65 65 50 L65 35 Z' fill='white'/><circle cx='50' cy='52' r='5' fill='url(%23g)'/><rect x='48' y='55' width='4' height='8' fill='url(%23g)'/></svg>">
  <link rel="stylesheet" href="style.css">
  <style>
    /* ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    #passwordModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .password-box {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      max-width: 280px;
      width: 90%;
    }

    .password-icon {
      text-align: center;
      font-size: 24px;
      margin-bottom: 15px;
    }

    #passwordInput {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border: 2px solid #007aff;
      border-radius: 8px;
      text-align: center;
      box-sizing: border-box;
    }

    #passwordInput:focus {
      outline: none;
      border-color: #0051d5;
    }

    .password-buttons {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }

    #decryptButton {
      flex: 1;
      padding: 12px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 500;
    }

    #decryptButton:hover {
      background: #0051d5;
    }

    #cancelButton {
      padding: 12px 16px;
      background: #f0f0f0;
      color: #666;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    #cancelButton:hover {
      background: #e0e0e0;
    }
  </style>
  <title>KyberChat - ì–‘ì ì•ˆì „ ì±„íŒ…</title>
</head>
<body>
  <!-- ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="usernameModal" class="modal">
    <div class="modal-content">
      <div style="text-align: center; margin-bottom: 20px;">
        <svg width="80" height="80" viewBox="0 0 100 100" style="margin-bottom: 10px;">
          <defs>
            <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#667eea"/>
              <stop offset="100%" style="stop-color:#764ba2"/>
            </linearGradient>
          </defs>
          <circle cx="50" cy="50" r="45" fill="url(#logoGrad)"/>
          <path d="M50 25 L35 35 L35 50 Q35 65 50 70 Q65 65 65 50 L65 35 Z" fill="white"/>
          <circle cx="50" cy="52" r="5" fill="url(#logoGrad)"/>
          <rect x="48" y="55" width="4" height="8" fill="url(#logoGrad)"/>
        </svg>
        <h2 style="margin: 0; font-size: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">KyberChat</h2>
        <p style="font-size: 13px; color: rgba(255,255,255,0.8); margin: 5px 0 0 0;">Quantum-Safe Messaging</p>
      </div>
      <p>ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
      <input type="text" id="usernameInput" placeholder="ì‚¬ìš©ì ì´ë¦„" maxlength="20">
      <div class="modal-buttons">
        <button id="joinButton">ì…ì¥í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="passwordModal">
    <div class="password-box">
      <div class="password-icon">ğŸ”</div>
      <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸" maxlength="4">
      <div class="password-buttons">
        <button id="decryptButton">í™•ì¸</button>
        <button id="cancelButton">âœ•</button>
      </div>
    </div>
  </div>

  <div class="chat-container" id="chatContainer" style="display: none;">
    <div class="chat-header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <svg width="36" height="36" viewBox="0 0 100 100">
          <defs>
            <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#ffffff"/>
              <stop offset="100%" style="stop-color:#f0f0f0"/>
            </linearGradient>
          </defs>
          <circle cx="50" cy="50" r="45" fill="url(#headerGrad)" opacity="0.3"/>
          <path d="M50 25 L35 35 L35 50 Q35 65 50 70 Q65 65 65 50 L65 35 Z" fill="white"/>
          <circle cx="50" cy="52" r="5" fill="rgba(255,255,255,0.5)"/>
          <rect x="48" y="55" width="4" height="8" fill="rgba(255,255,255,0.5)"/>
        </svg>
        <h3 style="margin: 0; font-weight: 600;">KyberChat</h3>
      </div>
      <div class="user-info">
        <span id="currentUsername"></span>
        <button id="changeUsernameButton">ì´ë¦„ ë³€ê²½</button>
      </div>
    </div>
    <div class="messages-container" id="messages"></div>
    <div class="message-input-container">
      <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
      <button id="sendButton">â–²</button>
    </div>
  </div>

  <script src="kyber.js"></script>
  <script>
    // DOM ìš”ì†Œë“¤
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const usernameModal = document.getElementById('usernameModal');
    const chatContainer = document.getElementById('chatContainer');
    const usernameInput = document.getElementById('usernameInput');
    const joinButton = document.getElementById('joinButton');
    const currentUsernameSpan = document.getElementById('currentUsername');
    const changeUsernameButton = document.getElementById('changeUsernameButton');
    const passwordModal = document.getElementById('passwordModal');
    const passwordInput = document.getElementById('passwordInput');
    const decryptButton = document.getElementById('decryptButton');
    const cancelButton = document.getElementById('cancelButton');
    
    const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
    let ws = null;
    let currentUsername = '';
    let isConnected = false;

    // Kyber í‚¤ ê´€ë¦¬
    let myKyber = { publicKey: null, secretKey: null };
    let peerPublicKey = null;
    let isKeyExchangeComplete = false;

    // ì „ì²´ í™”ë©´ ì•”í˜¸í™” ìƒíƒœ
    let isScreenEncrypted = false;
    let originalMessages = new Map();
    let autoEncryptTimer = null;

    // ===== ì‚¬ìš©ì ì´ë¦„ ê´€ë¦¬ =====
    function saveUsername(username) {
      localStorage.setItem('chatUsername', username);
    }

    function loadUsername() {
      return localStorage.getItem('chatUsername') || '';
    }

    async function connectToChat(username) {
      currentUsername = username;
      currentUsernameSpan.textContent = currentUsername;
      saveUsername(username);
      usernameModal.style.display = 'none';
      chatContainer.style.display = 'flex';
      
      // ë¨¼ì € Kyber ëª¨ë“ˆ ë¡œë“œ
      displaySystemMessage('Kyber ëª¨ë“ˆ ë¡œë”© ì¤‘...');
      try {
        await Kyber.ready();
        displaySystemMessage('Kyber ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ');
      } catch (error) {
        console.error('Kyber ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
        displaySystemMessage('Kyber ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // WebSocket ì—°ê²°
      displaySystemMessage('ì„œë²„ ì—°ê²° ì¤‘...');
               // Render.com ë°°í¬ìš© WebSocket ì—°ê²°
               ws = new WebSocket(`${wsProtocol}://${location.host}`);
      setupWebSocketHandlers();
    }

    // ===== WebSocket í•¸ë“¤ëŸ¬ =====
    function setupWebSocketHandlers() {
      ws.addEventListener('open', () => {
        isConnected = true;
        displaySystemMessage('ì„œë²„ ì—°ê²° ì™„ë£Œ! í‚¤ ìƒì„± ì¤‘...');
        messageInput.disabled = true;
        
        // í‚¤ ìƒì„± (ì§€ì—° ì—†ì´ ì¦‰ì‹œ ì‹¤í–‰)
        generateKyber().catch((error) => {
          console.error('í‚¤ ìƒì„± ì˜¤ë¥˜:', error);
          displaySystemMessage('í‚¤ ìƒì„± ì‹¤íŒ¨: ' + error.message);
        });
      });

      ws.addEventListener('message', async (event) => {
        try {
          const msg = JSON.parse(event.data);
          console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', msg.type);
          
          // ê³µê°œí‚¤ ìˆ˜ì‹ 
          if (msg.type === 'pubkey' && msg.key) {
            console.log('ìƒëŒ€ë°© ê³µê°œí‚¤ ìˆ˜ì‹ , ê¸¸ì´:', msg.key.length);
            peerPublicKey = base64ToBytes(msg.key);
            console.log('peerPublicKey ì„¤ì •ë¨, ë°”ì´íŠ¸ ê¸¸ì´:', peerPublicKey.length);
            
            // ë‚´ í‚¤ë„ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (myKyber.publicKey && myKyber.secretKey) {
              isKeyExchangeComplete = true;
              displaySystemMessage('í‚¤ êµí™˜ ì™„ë£Œ!');
              messageInput.disabled = false;
              messageInput.placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
              console.log('í‚¤ êµí™˜ ì™„ë£Œ! ë©”ì‹œì§€ ì…ë ¥ ê°€ëŠ¥');
            } else {
              displaySystemMessage('ìƒëŒ€ë°© ê³µê°œí‚¤ ìˆ˜ì‹ . ë‚´ í‚¤ ìƒì„± ì¤‘...');
              console.log('ë‚´ í‚¤ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ. ëŒ€ê¸° ì¤‘...');
            }
            return;
          }
          
          // ì•”í˜¸í™”ëœ ë©”ì‹œì§€ ìˆ˜ì‹ 
          if (msg.type === 'encrypted_message' && msg.encryptedContent) {
            try {
              const encryptedData = base64ToBytes(msg.encryptedContent);
              const decryptedMessage = await Kyber.decrypt(encryptedData, myKyber.secretKey);
              displayMessage(decryptedMessage, false, msg.username || 'ì•Œ ìˆ˜ ì—†ìŒ');
            } catch (error) {
              displaySystemMessage('ë³µí˜¸í™” ì‹¤íŒ¨: ' + error.message);
            }
            return;
          }
          
          // í‰ë¬¸ ë©”ì‹œì§€
          if (msg.content) {
            displayMessage(msg.content, false, msg.username || 'ì•Œ ìˆ˜ ì—†ìŒ');
          }
        } catch (error) {
          // JSON ì•„ë‹˜ - í‰ë¬¸ìœ¼ë¡œ ì²˜ë¦¬
          if (event.data.length > 2) {
            displayMessage(event.data, false, 'ì•Œ ìˆ˜ ì—†ìŒ');
          }
        }
      });

      ws.addEventListener('close', () => {
        isConnected = false;
        displaySystemMessage('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
        console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
      });

      ws.addEventListener('error', (error) => {
        console.error('WebSocket ì˜¤ë¥˜:', error);
        displaySystemMessage('ì—°ê²° ì˜¤ë¥˜ ë°œìƒ');
      });
    }

    // ===== Kyber ê´€ë ¨ í•¨ìˆ˜ =====
    function bytesToBase64(bytes) {
      return btoa(String.fromCharCode(...new Uint8Array(bytes)));
    }

    function base64ToBytes(b64) {
      const bin = atob(b64);
      const bytes = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
      return bytes;
    }

    async function generateKyber() {
      // Kyber.ready()ëŠ” ì´ë¯¸ connectToChat()ì—ì„œ í˜¸ì¶œë¨
      const { publicKey, secretKey } = await Kyber.keypair();
      myKyber.publicKey = publicKey;
      myKyber.secretKey = secretKey;
      console.log('ë‚´ í‚¤ ìƒì„± ì™„ë£Œ. publicKey ê¸¸ì´:', publicKey.length, 'secretKey ê¸¸ì´:', secretKey.length);
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ 
          type: 'pubkey', 
          alg: 'KYBER512', 
          key: bytesToBase64(publicKey) 
        }));
        console.log('ë‚´ ê³µê°œí‚¤ ì „ì†¡ ì™„ë£Œ');
        displaySystemMessage('ê³µê°œí‚¤ ì „ì†¡ ì™„ë£Œ. ìƒëŒ€ë°© ëŒ€ê¸° ì¤‘...');
      }
      
      // ìƒëŒ€ë°© ê³µê°œí‚¤ê°€ ì´ë¯¸ ë„ì°©í–ˆëŠ”ì§€ í™•ì¸
      if (peerPublicKey && peerPublicKey.length > 0) {
        isKeyExchangeComplete = true;
        displaySystemMessage('í‚¤ êµí™˜ ì™„ë£Œ!');
        messageInput.disabled = false;
        messageInput.placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
        console.log('í‚¤ êµí™˜ ì™„ë£Œ! (ìƒëŒ€ë°© í‚¤ ì´ë¯¸ ìˆ˜ì‹ ë¨)');
      }
    }

    // ===== ë©”ì‹œì§€ ì „ì†¡ =====
    sendButton.addEventListener('click', async () => {
      const message = messageInput.value.trim();
      if (!message || !isKeyExchangeComplete) return;
      
      try {
        // ì•”í˜¸í™”
        const encryptedData = await Kyber.encrypt(peerPublicKey, message);
        const encryptedBase64 = bytesToBase64(encryptedData);
        
        // ì „ì†¡
        ws.send(JSON.stringify({ 
          type: 'encrypted_message', 
          username: currentUsername,
          encryptedContent: encryptedBase64
        }));
        
        // í‘œì‹œ
        displayMessage(message, true, currentUsername);
        messageInput.value = '';
      } catch (error) {
        displaySystemMessage('ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
      }
    });

    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendButton.click();
    });

    // ===== ë©”ì‹œì§€ í‘œì‹œ =====
    function displayMessage(message, isSender = false, username = '') {
      console.log('[displayMessage] í˜¸ì¶œë¨. isScreenEncrypted:', isScreenEncrypted);
      
      const messageContainer = document.createElement('div');
      const messageElement = document.createElement('div');
      
      // ì‚¬ìš©ì ì´ë¦„
      if (username && username !== 'ì•Œ ìˆ˜ ì—†ìŒ') {
        const usernameElement = document.createElement('div');
        usernameElement.textContent = username;
        usernameElement.classList.add('message-username');
        messageContainer.appendChild(usernameElement);
      }
      
      messageContainer.classList.add('message-container');
      
      if (isSender) {
        messageContainer.classList.add('sender-message-container');
        messageElement.classList.add('message-bubble', 'sender-message-bubble');
      } else {
        messageElement.classList.add('message-bubble');
      }
      
      // í•­ìƒ í‰ë¬¸ìœ¼ë¡œ í‘œì‹œ (ì•”í˜¸í™” ìƒíƒœì™€ ë¬´ê´€)
      messageElement.textContent = message;
      originalMessages.set(messageElement, message);
      
      messageContainer.appendChild(messageElement);
      messagesDiv.appendChild(messageContainer);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      // í™”ë©´ì´ ì•”í˜¸í™”ë˜ì–´ ìˆìœ¼ë©´ ì•”í˜¸í™” ìƒíƒœë¥¼ í•´ì œí•˜ê³  íƒ€ì´ë¨¸ ì¬ì‹œì‘
      if (isScreenEncrypted) {
        console.log('[displayMessage] í™”ë©´ì´ ì•”í˜¸í™”ë¨. ìƒíƒœ í•´ì œí•˜ê³  íƒ€ì´ë¨¸ ì¬ì‹œì‘');
        isScreenEncrypted = false;
      }
      
      // ê¸°ì¡´ íƒ€ì´ë¨¸ë¥¼ ì·¨ì†Œí•˜ê³  ìƒˆë¡œ ì‹œì‘
      if (autoEncryptTimer) {
        console.log('[displayMessage] ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ');
        clearTimeout(autoEncryptTimer);
      }
      
      // 10ì´ˆ í›„ ì „ì²´ ì•”í˜¸í™”
      console.log('[displayMessage] 10ì´ˆ íƒ€ì´ë¨¸ ì‹œì‘');
      startAutoEncryptTimer();
    }

    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ìš”ì†Œ (ì¬ì‚¬ìš©)
    let systemMessageElement = null;
    let systemMessageTimer = null;

    function displaySystemMessage(message) {
      // ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
      if (systemMessageTimer) {
        clearTimeout(systemMessageTimer);
      }
      
      // ê¸°ì¡´ ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ìƒì„±
      if (!systemMessageElement) {
        systemMessageElement = document.createElement('div');
        systemMessageElement.style.textAlign = 'center';
        systemMessageElement.style.color = '#999';
        systemMessageElement.style.fontSize = '12px';
        systemMessageElement.style.margin = '10px 0';
        systemMessageElement.style.transition = 'opacity 0.3s';
        messagesDiv.appendChild(systemMessageElement);
      }
      
      // ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      systemMessageElement.textContent = `ğŸ” ${message}`;
      systemMessageElement.style.opacity = '1';
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      // 3ì´ˆ í›„ í˜ì´ë“œì•„ì›ƒ í›„ ì œê±°
      systemMessageTimer = setTimeout(() => {
        if (systemMessageElement) {
          systemMessageElement.style.opacity = '0';
          setTimeout(() => {
            if (systemMessageElement && systemMessageElement.parentNode) {
              systemMessageElement.parentNode.removeChild(systemMessageElement);
              systemMessageElement = null;
            }
          }, 300);
        }
      }, 3000);
    }

    // ===== ì „ì²´ í™”ë©´ ì•”í˜¸í™”/ë³µí˜¸í™” =====
    function generateRandomHex(length) {
      const chars = '0123456789abcdef';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars[Math.floor(Math.random() * chars.length)];
      }
      return result;
    }

    function encryptAllMessages() {
      console.log('[encryptAllMessages] í˜¸ì¶œë¨. isScreenEncrypted:', isScreenEncrypted);
      if (isScreenEncrypted) {
        console.log('[encryptAllMessages] ì´ë¯¸ ì•”í˜¸í™”ë¨. ì¢…ë£Œ');
        return;
      }
      
      // íƒ€ì´ë¨¸ ì •ë¦¬
      if (autoEncryptTimer) {
        clearTimeout(autoEncryptTimer);
        autoEncryptTimer = null;
      }
      
      // originalMessages.clear()ë¥¼ ì œê±°í•˜ì—¬ ê¸°ì¡´ ë©”ì‹œì§€ ìœ ì§€
      const messageElements = document.querySelectorAll('.message-bubble');
      console.log('[encryptAllMessages] ì•”í˜¸í™”í•  ë©”ì‹œì§€ ìˆ˜:', messageElements.length);
      
      messageElements.forEach((el) => {
        const text = el.textContent;
        if (!text.startsWith('ğŸ”')) {
          // ì•„ì§ originalMessagesì— ì—†ìœ¼ë©´ ì €ì¥
          if (!originalMessages.has(el)) {
            originalMessages.set(el, text);
          }
          el.textContent = 'ğŸ” ' + generateRandomHex(32) + '...';
          el.style.fontFamily = 'monospace';
          el.style.fontSize = '12px';
          el.style.color = '#666';
        }
      });
      
      isScreenEncrypted = true;
      console.log('[encryptAllMessages] ì•”í˜¸í™” ì™„ë£Œ. isScreenEncrypted:', isScreenEncrypted);
    }

    function decryptAllMessages() {
      console.log('[decryptAllMessages] í˜¸ì¶œë¨. isScreenEncrypted:', isScreenEncrypted);
      if (!isScreenEncrypted) {
        console.log('[decryptAllMessages] ì•”í˜¸í™” ì•ˆë¨. ì¢…ë£Œ');
        return;
      }
      
      const messageElements = document.querySelectorAll('.message-bubble');
      console.log('[decryptAllMessages] ë³µí˜¸í™”í•  ë©”ì‹œì§€ ìˆ˜:', messageElements.length);
      
      messageElements.forEach((el) => {
        if (el.textContent.startsWith('ğŸ”')) {
          const original = originalMessages.get(el);
          if (original) {
            el.textContent = original;
            el.style.fontFamily = '';
            el.style.fontSize = '';
            el.style.color = '';
          }
        }
      });
      
      isScreenEncrypted = false;
      console.log('[decryptAllMessages] ë³µí˜¸í™” ì™„ë£Œ. isScreenEncrypted:', isScreenEncrypted);
      
      // ë³µí˜¸í™” í›„ 10ì´ˆ ë’¤ ë‹¤ì‹œ ì•”í˜¸í™”
      console.log('[decryptAllMessages] 10ì´ˆ íƒ€ì´ë¨¸ ì‹œì‘');
      startAutoEncryptTimer();
    }

    function startAutoEncryptTimer() {
      console.log('[startAutoEncryptTimer] í˜¸ì¶œë¨');
      if (autoEncryptTimer) {
        console.log('[startAutoEncryptTimer] ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ');
        clearTimeout(autoEncryptTimer);
      }
      
      autoEncryptTimer = setTimeout(() => {
        console.log('[startAutoEncryptTimer] 10ì´ˆ ê²½ê³¼. isScreenEncrypted:', isScreenEncrypted);
        if (!isScreenEncrypted) {
          encryptAllMessages();
        } else {
          console.log('[startAutoEncryptTimer] ì´ë¯¸ ì•”í˜¸í™”ë¨. ìŠ¤í‚µ');
        }
      }, 10000);
      console.log('[startAutoEncryptTimer] íƒ€ì´ë¨¸ ì„¤ì • ì™„ë£Œ');
    }

    // ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ =====
    // ì•”í˜¸í™”ëœ í™”ë©´ í´ë¦­ ì‹œ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬
    document.addEventListener('click', (event) => {
      if (passwordModal.style.display === 'flex') return;
      
      if ((event.target.closest('.messages-container') || event.target.closest('.message-bubble')) && isScreenEncrypted) {
        passwordModal.style.display = 'flex';
        passwordInput.focus();
      }
    });

    // ë³µí˜¸í™” ë²„íŠ¼
    decryptButton.addEventListener('click', () => {
      if (passwordInput.value === '1234') {
        decryptAllMessages();
        passwordModal.style.display = 'none';
        passwordInput.value = '';
      } else {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        passwordInput.value = '';
        passwordInput.focus();
      }
    });

    // ì·¨ì†Œ ë²„íŠ¼
    cancelButton.addEventListener('click', () => {
      passwordModal.style.display = 'none';
      passwordInput.value = '';
    });

    // Enter í‚¤
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') decryptButton.click();
    });

    // ESC í‚¤
    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') cancelButton.click();
    });

    // ===== ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ =====
    joinButton.addEventListener('click', () => {
      const username = usernameInput.value.trim();
      if (username.length < 2) {
        alert('ì‚¬ìš©ì ì´ë¦„ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      connectToChat(username);
    });

    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') joinButton.click();
    });

    changeUsernameButton.addEventListener('click', () => {
      if (confirm('ì´ë¦„ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        usernameModal.style.display = 'flex';
        chatContainer.style.display = 'none';
        usernameInput.value = currentUsername;
        usernameInput.select();
      }
    });

    // ===== ì´ˆê¸°í™” =====
    window.addEventListener('load', () => {
      const savedUsername = loadUsername();
      if (savedUsername) {
        usernameInput.value = savedUsername;
        connectToChat(savedUsername);
      } else {
        usernameModal.style.display = 'flex';
      }
    });
  </script>
</body>
</html>
