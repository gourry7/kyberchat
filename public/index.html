<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%23667eea'/><stop offset='100%25' style='stop-color:%23764ba2'/></linearGradient></defs><circle cx='50' cy='50' r='45' fill='url(%23g)'/><path d='M50 25 L35 35 L35 50 Q35 65 50 70 Q65 65 65 50 L65 35 Z' fill='white'/><circle cx='50' cy='52' r='5' fill='url(%23g)'/><rect x='48' y='55' width='4' height='8' fill='url(%23g)'/></svg>">
  <link rel="stylesheet" href="style.css">
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    * {
      box-sizing: border-box;
    }
    
    /* ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    #passwordModal, #passwordSetupModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .password-box {
      background: white;
      padding: 33px;
      border-radius: 17px;
      box-shadow: 0 7px 33px rgba(0,0,0,0.4);
      max-width: 333px;
      width: 95%;
      text-align: center;
    }

    .password-icon {
      text-align: center;
      font-size: 43px;
      margin-bottom: 17px;
    }

    .password-title {
      font-size: 19px;
      font-weight: bold;
      color: #333;
      margin-bottom: 13px;
    }

    .password-description {
      font-size: 12px;
      color: #666;
      margin-bottom: 23px;
      line-height: 1.6;
    }

    #passwordInput, #newPasswordInput, #confirmPasswordInput {
      width: 100%;
      padding: 17px;
      font-size: 19px;
      border: 3px solid #007aff;
      border-radius: 10px;
      text-align: center;
      box-sizing: border-box;
      margin-bottom: 13px;
      font-weight: bold;
      letter-spacing: 2px;
    }

    #passwordInput:focus, #newPasswordInput:focus, #confirmPasswordInput:focus {
      outline: none;
      border-color: #0051d5;
      box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
    }

    .password-buttons {
      display: flex;
      gap: 13px;
      margin-top: 17px;
    }

    #decryptButton, #setPasswordButton {
      flex: 1;
      padding: 15px 20px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    #decryptButton:hover, #setPasswordButton:hover {
      background: #0051d5;
      transform: translateY(-2px);
      box-shadow: 0 4px 13px rgba(0, 122, 255, 0.4);
    }

    #cancelButton, #cancelSetupButton {
      padding: 15px 20px;
      background: #f0f0f0;
      color: #666;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    #cancelButton:hover, #cancelSetupButton:hover {
      background: #e0e0e0;
      transform: translateY(-2px);
    }
    

    /* ì‚¬ìš©ì ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .user-list-button {
      background: #007aff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-left: 12px;
    }

    .user-list-button:hover {
      background: #0051d5;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }

    .user-list-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .user-list-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .user-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .user-list-header h3 {
      margin: 0;
      color: #333;
      font-size: 18px;
    }

    .close-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .close-button:hover {
      background: #f0f0f0;
      color: #333;
    }

    .user-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .user-item:hover {
      background: #e3f2fd;
      border-color: #007aff;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
    }

    .user-item.selected {
      background: #007aff;
      color: white;
      border-color: #0051d5;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap; /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ì´ ì¤„ë°”ê¿ˆë˜ë„ë¡ */
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }

    .user-name {
      font-weight: 600;
      font-size: 16px;
    }

    .user-status {
      font-size: 12px;
      color: #28a745;
      font-weight: 500;
    }

    .user-item.selected .user-status {
      color: #a8d8ff;
    }

    .select-button {
      background: #007aff;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .select-button:hover {
      background: #0051d5;
      transform: translateY(-1px);
    }

    .user-item.selected .select-button {
      background: white;
      color: #007aff;
    }

    .loading-users {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }

    .no-users {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }

    /* ì‚¬ìš©ì ëª©ë¡ í™”ë©´ ìŠ¤íƒ€ì¼ */
    .user-list-screen {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .user-list-header {
      background: rgba(255, 255, 255, 0.95);
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-list-content-main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .main-user-list {
      max-width: 600px;
      margin: 0 auto;
    }

    .main-user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .main-user-item:hover {
      background: rgba(255, 255, 255, 1);
      border-color: #007aff;
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 122, 255, 0.2);
    }

    .main-user-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: rgba(255, 255, 255, 0.7);
    }

    .main-user-item.disabled:hover {
      transform: none;
      border-color: transparent;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .main-user-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .main-user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    .main-user-details {
      display: flex;
      flex-direction: column;
    }

    .main-user-name {
      font-weight: 600;
      font-size: 18px;
      color: #333;
      margin-bottom: 4px;
    }

    .main-user-status {
      font-size: 14px;
      font-weight: 500;
    }

    .main-user-status.online {
      color: #28a745;
    }

    .main-user-status.busy {
      color: #ff6b6b;
    }

    .main-chat-button {
      background: #007aff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .main-chat-button:hover {
      background: #0051d5;
      transform: translateY(-1px);
    }

    .main-chat-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 768px) {
      .password-box {
        padding: 27px 20px;
        max-width: 90%;
      }
      
      .password-icon {
        font-size: 37px;
      }
      
      .password-title {
      font-size: 16px;
      }
      
      .password-description {
        font-size: 11px;
      }
      
      #passwordInput, #newPasswordInput, #confirmPasswordInput {
        padding: 13px;
        font-size: 16px;
      }
      
      .password-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      #decryptButton, #setPasswordButton, #cancelButton, #cancelSetupButton {
        padding: 12px 17px;
        font-size: 12px;
      }

      .user-list-content {
        padding: 20px;
        max-width: 95%;
      }

      .user-list-header h3 {
        font-size: 16px;
      }

      .user-item {
        padding: 10px 12px;
      }

      .user-name {
        font-size: 14px;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }
      
      /* ì±„íŒ… í—¤ë” ëª¨ë°”ì¼ ëŒ€ì‘ */
      .user-info {
        gap: 6px;
      }
      
      .user-info span {
        width: 100%; /* ì‚¬ìš©ì ì´ë¦„ì€ ì „ì²´ ë„ˆë¹„ */
        margin-bottom: 2px;
        font-size: 14px;
      }
      
      .user-info button {
        flex: 1 1 calc(50% - 3px); /* ë²„íŠ¼ì€ í•œ ì¤„ì— 2ê°œì”© */
        min-width: 0;
        font-size: 10px !important;
        padding: 6px 8px !important;
        min-height: 32px !important;
        max-height: 32px !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      /* ë°©ì—ì„œ ë‚˜ê°€ê¸° ë²„íŠ¼ì€ ì „ì²´ ë„ˆë¹„ */
      #backToUserList {
        flex: 1 1 100% !important;
        font-size: 11px !important;
        padding: 7px 10px !important;
      }
      
      /* ì‚¬ìš©ì ëª©ë¡ í™”ë©´ ìƒë‹¨ ë²„íŠ¼ë“¤ (ì´ë¦„ ë³€ê²½, ë¹„ë°€ë²ˆí˜¸ ì„¤ì •) */
      #changeUsernameButton,
      #passwordSetupButton {
        font-size: 13px !important;
        padding: 8px 12px !important;
        min-height: 36px !important;
        max-height: 36px !important;
        max-width: 120px !important;
        flex: 0 0 auto !important;
      }
      
      .user-list-header .user-info {
        gap: 8px;
        justify-content: flex-start;
      }
      
      .user-list-header .user-info span {
        font-size: 14px;
        flex: 0 0 auto;
      }
    }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* ì±„íŒ…í•˜ê¸° ë²„íŠ¼ */
    .main-chat-button {
      background: linear-gradient(135deg, #007aff, #0051d5);
      color: white;
      font-size: 16px;
      padding: 14px 24px;
      min-height: 48px;
    }

    .main-chat-button:hover {
      background: linear-gradient(135deg, #0051d5, #003d99);
    }

    .main-chat-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ë°©ì—ì„œ ë‚˜ê°€ê¸° ë²„íŠ¼ */
    #backToUserList {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: white;
      font-size: 16px;
      padding: 14px 24px;
      min-height: 48px;
    }

    #backToUserList:hover {
      background: linear-gradient(135deg, #495057, #343a40);
    }

    /* ê¸°ë¡ ì‚­ì œ ë²„íŠ¼ */
    #clearHistoryButton {
      background: linear-gradient(135deg, #ff6b6b, #e74c3c);
      color: white;
      font-size: 16px;
      padding: 14px 24px;
      min-height: 48px;
    }

    #clearHistoryButton:hover {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    /* ì…ì¥í•˜ê¸° ë²„íŠ¼ */
    #joinButton {
      background: linear-gradient(135deg, #28a745, #1e7e34);
      color: white;
      font-size: 18px;
      padding: 16px 32px;
      min-height: 56px;
      width: 100%;
    }

    #joinButton:hover {
      background: linear-gradient(135deg, #1e7e34, #155724);
    }

    /* ë¹„ë°€ë²ˆí˜¸ ê´€ë ¨ ë²„íŠ¼ë“¤ */
    #decryptButton, #setPasswordButton {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: white;
      font-size: 16px;
      padding: 14px 24px;
      min-height: 48px;
    }

    #decryptButton:hover, #setPasswordButton:hover {
      background: linear-gradient(135deg, #138496, #117a8b);
    }

    #cancelButton, #cancelSetupButton {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: white;
      font-size: 16px;
      padding: 14px 24px;
      min-height: 48px;
    }

    #cancelButton:hover, #cancelSetupButton:hover {
      background: linear-gradient(135deg, #495057, #343a40);
    }

    /* ëŒ€í™” ìš”ì²­ ë²„íŠ¼ë“¤ */
    #acceptChatButton {
      background: linear-gradient(135deg, #28a745, #1e7e34);
      color: white;
      font-size: 16px;
      padding: 14px 24px;
      min-height: 48px;
    }

    #acceptChatButton:hover {
      background: linear-gradient(135deg, #1e7e34, #155724);
    }

    #rejectChatButton {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
      font-size: 16px;
      padding: 14px 24px;
      min-height: 48px;
    }

    #rejectChatButton:hover {
      background: linear-gradient(135deg, #c82333, #a71e2a);
    }

    /* ì‚¬ìš©ì ì´ë¦„ ë³€ê²½ ë²„íŠ¼ */
    #changeUsernameButton {
      background: linear-gradient(135deg, #ffc107, #e0a800);
      color: #212529;
      font-size: 14px;
      padding: 10px 16px;
      min-height: 40px;
    }

    #changeUsernameButton:hover {
      background: linear-gradient(135deg, #e0a800, #d39e00);
    }

    /* ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ë²„íŠ¼ */
    #passwordSetupButton {
      background: linear-gradient(135deg, #6f42c1, #5a32a3);
      color: white;
      font-size: 14px;
      padding: 10px 16px;
      min-height: 40px;
    }

    #passwordSetupButton:hover {
      background: linear-gradient(135deg, #5a32a3, #4c2a85);
    }
  </style>
  <title>KyberChat - ì–‘ì ì•ˆì „ ì±„íŒ…</title>
</head>
<body>
  <!-- ëŒ€í™” ìš”ì²­ ì•Œë¦¼ ëª¨ë‹¬ -->
  <div id="chatRequestModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>ğŸ’¬ ëŒ€í™” ìš”ì²­</h2>
      <p id="chatRequestMessage"></p>
      <div class="modal-buttons">
        <button id="acceptChatButton" style="background: #28a745; color: white;">ìˆ˜ë½</button>
        <button id="rejectChatButton" style="background: #dc3545; color: white;">ê±°ì ˆ</button>
      </div>
    </div>
  </div>

  <!-- ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="usernameModal" class="modal">
    <div class="modal-content">
      <div style="text-align: center; margin-bottom: 20px;">
        <svg width="80" height="80" viewBox="0 0 100 100" style="margin-bottom: 10px;">
          <defs>
            <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#667eea"/>
              <stop offset="100%" style="stop-color:#764ba2"/>
            </linearGradient>
          </defs>
          <circle cx="50" cy="50" r="45" fill="url(#logoGrad)"/>
          <path d="M50 25 L35 35 L35 50 Q35 65 50 70 Q65 65 65 50 L65 35 Z" fill="white"/>
          <circle cx="50" cy="52" r="5" fill="url(#logoGrad)"/>
          <rect x="48" y="55" width="4" height="8" fill="url(#logoGrad)"/>
        </svg>
        <h2 style="margin: 0; font-size: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">KyberChat</h2>
        <p style="font-size: 13px; color: rgba(255,255,255,0.8); margin: 5px 0 0 0;">Quantum-Safe Messaging</p>
      </div>
      <p>ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
      <input type="text" id="usernameInput" placeholder="ì‚¬ìš©ì ì´ë¦„" maxlength="20">
      <div class="modal-buttons">
        <button id="joinButton">ì…ì¥í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="passwordModal">
    <div class="password-box">
      <div class="password-icon">ğŸ”</div>
      <div class="password-title">í™”ë©´ ë³µí˜¸í™”</div>
      <div class="password-description">ì•”í˜¸í™”ëœ ë©”ì‹œì§€ë¥¼ ë³´ë ¤ë©´<br>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
      <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" maxlength="20">
      <div class="password-buttons">
        <button id="decryptButton">ë³µí˜¸í™”</button>
        <button id="cancelButton">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ëª¨ë‹¬ -->
  <div id="passwordSetupModal" style="display: none;">
    <div class="password-box">
      <div class="password-icon">ğŸ”‘</div>
      <div class="password-title">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</div>
      <div class="password-description">í™”ë©´ ì•”í˜¸í™”ì— ì‚¬ìš©í• <br>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”<br><small style="color: #999;">4ì ì´ìƒ 20ì ì´í•˜</small></div>
      <input type="password" id="newPasswordInput" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" maxlength="20">
      <input type="password" id="confirmPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" maxlength="20">
      <div class="password-buttons">
        <button id="setPasswordButton">ì„¤ì •í•˜ê¸°</button>
        <button id="cancelSetupButton">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- ì‚¬ìš©ì ëª©ë¡ í™”ë©´ -->
  <div class="user-list-screen" id="userListScreen" style="display: none;">
    <div class="user-list-header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <svg width="36" height="36" viewBox="0 0 100 100">
          <defs>
            <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#ffffff"/>
              <stop offset="100%" style="stop-color:#f0f0f0"/>
            </linearGradient>
          </defs>
          <circle cx="50" cy="50" r="45" fill="url(#headerGrad)" opacity="0.3"/>
          <path d="M50 25 L35 35 L35 50 Q35 65 50 70 Q65 65 65 50 L65 35 Z" fill="white"/>
          <circle cx="50" cy="52" r="5" fill="rgba(255,255,255,0.5)"/>
          <rect x="48" y="55" width="4" height="8" fill="rgba(255,255,255,0.5)"/>
        </svg>
        <h3 style="margin: 0; font-weight: 600;">KyberChat</h3>
      </div>
      <div class="user-info">
        <span id="currentUsername"></span>
        <button id="changeUsernameButton">ì´ë¦„ ë³€ê²½</button>
        <button id="passwordSetupButton" style="background: #28a745; color: white; margin-left: 8px;">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</button>
      </div>
    </div>
    <div class="user-list-content-main">
      <h2 style="text-align: center; margin-bottom: 20px; color: #333;">ğŸ‘¥ ì ‘ì†í•œ ì‚¬ìš©ì</h2>
      <div id="mainUserList" class="main-user-list">
        <div class="loading-users">ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>
  </div>

  <!-- ì±„íŒ…ë°© í™”ë©´ -->
  <div class="chat-container" id="chatContainer" style="display: none;">
    <div class="chat-header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <svg width="36" height="36" viewBox="0 0 100 100">
          <defs>
            <linearGradient id="headerGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#ffffff"/>
              <stop offset="100%" style="stop-color:#f0f0f0"/>
            </linearGradient>
          </defs>
          <circle cx="50" cy="50" r="45" fill="url(#headerGrad2)" opacity="0.3"/>
          <path d="M50 25 L35 35 L35 50 Q35 65 50 70 Q65 65 65 50 L65 35 Z" fill="white"/>
          <circle cx="50" cy="52" r="5" fill="rgba(255,255,255,0.5)"/>
          <rect x="48" y="55" width="4" height="8" fill="rgba(255,255,255,0.5)"/>
        </svg>
        <h3 style="margin: 0; font-weight: 600;">KyberChat</h3>
      </div>
      <div class="user-info">
        <span id="currentUsernameChat"></span>
        <button id="clearHistoryButton" style="background: #ff6b6b; color: white; margin-left: 8px;">ğŸ—‘ï¸ ê¸°ë¡ ì‚­ì œ</button>
        <button id="backToUserList" style="background: #6c757d; color: white; margin-left: 8px;">ğŸšª ë°©ì—ì„œ ë‚˜ê°€ê¸°</button>
      </div>
    </div>
    <div class="messages-container" id="messages"></div>
    <div class="message-input-container">
      <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
      <button id="sendButton">â–²</button>
    </div>
  </div>

  <!-- ì‚¬ìš©ì ëª©ë¡ ëª¨ë‹¬ -->
  <div id="userListModal" class="user-list-modal">
    <div class="user-list-content">
      <div class="user-list-header">
        <h3>ğŸ‘¥ ì ‘ì†í•œ ì‚¬ìš©ì</h3>
        <button id="closeUserList" class="close-button">âœ•</button>
      </div>
      <div id="userList" class="user-list">
        <div class="loading-users">ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>
  </div>

  <script src="kyber.js"></script>
  <script>
    // DOM ìš”ì†Œë“¤
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const usernameModal = document.getElementById('usernameModal');
    const userListScreen = document.getElementById('userListScreen');
    const chatContainer = document.getElementById('chatContainer');
    const usernameInput = document.getElementById('usernameInput');
    const joinButton = document.getElementById('joinButton');
    const currentUsernameSpan = document.getElementById('currentUsername');
    const currentUsernameChatSpan = document.getElementById('currentUsernameChat');
    const changeUsernameButton = document.getElementById('changeUsernameButton');
    const backToUserListButton = document.getElementById('backToUserList');
    
    // ë°©ì—ì„œ ë‚˜ê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    if (backToUserListButton) {
      backToUserListButton.addEventListener('click', () => {
        console.log('ë°©ì—ì„œ ë‚˜ê°€ê¸° ë²„íŠ¼ í´ë¦­ë¨');
        
        // ëŒ€í™” ì¢…ë£Œ ìš”ì²­
        ws.send(JSON.stringify({
          type: 'end_chat'
        }));
        
        // ì‚¬ìš©ì ëª©ë¡ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        chatContainer.style.display = 'none';
        userListScreen.style.display = 'flex';
        
        // ìƒíƒœ ì´ˆê¸°í™”
        selectedUserId = null;
        currentChatId = null;
        isInChat = false;
        
        // ë©”ì‹œì§€ ì…ë ¥ì°½ ë¹„í™œì„±í™”
        messageInput.disabled = true;
        messageInput.placeholder = 'ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”...';
        
        displaySystemMessage('ëŒ€í™”ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.');
      });
    }
    const passwordModal = document.getElementById('passwordModal');
    const passwordInput = document.getElementById('passwordInput');
    const decryptButton = document.getElementById('decryptButton');
    const cancelButton = document.getElementById('cancelButton');
    const chatRequestModal = document.getElementById('chatRequestModal');
    const chatRequestMessage = document.getElementById('chatRequestMessage');
    const acceptChatButton = document.getElementById('acceptChatButton');
    const rejectChatButton = document.getElementById('rejectChatButton');
    
    const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
    let ws = null;
    let currentUsername = '';
    let isConnected = false;
    let currentUserId = null; // í˜„ì¬ ì‚¬ìš©ì ID
    let selectedUserId = null;
    let currentChatId = null;
    let isInChat = false;
    let currentChatRequest = null; // í˜„ì¬ ëŒ€í™” ìš”ì²­ ì •ë³´
    let isRestoringHistory = false; // ë©”ì‹œì§€ ë³µì› ì¤‘ì¸ì§€ ì¶”ì 

    // Kyber í‚¤ ê´€ë¦¬
    let myKyber = { publicKey: null, secretKey: null };
    let peerPublicKey = null;
    let isKeyExchangeComplete = false;

    // ì „ì²´ í™”ë©´ ì•”í˜¸í™” ìƒíƒœ
    let isScreenEncrypted = false;
    let originalMessages = new Map();
    let autoEncryptTimer = null;

    // ì‚¬ìš©ì ëª©ë¡ ê´€ë¦¬
    const userListModal = document.getElementById('userListModal');
    const userListButton = document.getElementById('userListButton');
    const closeUserList = document.getElementById('closeUserList');
    const userList = document.getElementById('userList');
    let connectedUsers = new Map(); // ì‚¬ìš©ì ID -> ì‚¬ìš©ì ì •ë³´

    // ë¡œì»¬ ì €ì¥ì†Œ ê´€ë¦¬
    const CHAT_STORAGE_KEY = 'kyberchat_encrypted_messages';
    const STORAGE_PASSWORD = '1234'; // ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸
    const KYBER_STORAGE_KEY = 'kyberchat_kyber_messages'; // Kyber í‚¤ë¡œ ì•”í˜¸í™”ëœ ë©”ì‹œì§€
    const PASSWORD_STORAGE_KEY = 'kyberchat_user_password'; // ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ì €ì¥

    // ===== ë¡œì»¬ ì €ì¥ì†Œ ì•”í˜¸í™”/ë³µí˜¸í™” =====
    function simpleEncrypt(text, password) {
      const textBytes = new TextEncoder().encode(text);
      const passwordBytes = new TextEncoder().encode(password);
      const encrypted = new Uint8Array(textBytes.length);
      
      for (let i = 0; i < textBytes.length; i++) {
        encrypted[i] = textBytes[i] ^ passwordBytes[i % passwordBytes.length];
      }
      
      return btoa(String.fromCharCode(...encrypted));
    }

    function simpleDecrypt(encryptedText, password) {
      try {
        const encrypted = new Uint8Array(atob(encryptedText).split('').map(c => c.charCodeAt(0)));
        const passwordBytes = new TextEncoder().encode(password);
        const decrypted = new Uint8Array(encrypted.length);
        
        for (let i = 0; i < encrypted.length; i++) {
          decrypted[i] = encrypted[i] ^ passwordBytes[i % passwordBytes.length];
        }
        
        return new TextDecoder().decode(decrypted);
      } catch (error) {
        console.error('ë³µí˜¸í™” ì‹¤íŒ¨:', error);
        return null;
      }
    }

    function saveChatMessage(message, username, isSender, timestamp, chatId = null) {
      try {
        console.log('saveChatMessage í˜¸ì¶œë¨:', username, message.substring(0, 20) + '...', 'ë°©ID:', chatId);
        console.log('saveChatMessage - currentChatId:', currentChatId, 'ì „ë‹¬ë°›ì€ chatId:', chatId);
        
        const roomKey = chatId ? `kyberchat_messages_${chatId}` : 'kyberchat_messages_general';
        console.log('saveChatMessage - ì‚¬ìš©í•  roomKey:', roomKey);
        
        const chatData = {
          message: message,
          username: username,
          isSender: isSender,
          timestamp: timestamp || Date.now()
        };
        
        const existingData = localStorage.getItem(roomKey);
        console.log('ê¸°ì¡´ ì €ì¥ëœ ë°ì´í„° (ë°©:', chatId || 'general', '):', existingData ? 'ìˆìŒ' : 'ì—†ìŒ');
        
        let messages = [];
        if (existingData) {
          try {
            const decryptedData = simpleDecrypt(existingData, getUserPassword());
            if (decryptedData) {
              messages = JSON.parse(decryptedData);
              console.log('ê¸°ì¡´ ë©”ì‹œì§€ ë³µì› (ë°©:', chatId || 'general', '):', messages.length + 'ê°œ');
            } else {
              // ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ë¡œ ì¬ì‹œë„
              const fallbackDecrypted = simpleDecrypt(existingData, STORAGE_PASSWORD);
              if (fallbackDecrypted) {
                messages = JSON.parse(fallbackDecrypted);
                console.log('ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ë¡œ ê¸°ì¡´ ë©”ì‹œì§€ ë³µì› (ë°©:', chatId || 'general', '):', messages.length + 'ê°œ');
              }
            }
          } catch (e) {
            console.log('ê¸°ì¡´ ë°ì´í„° ë³µí˜¸í™” ì‹¤íŒ¨, ìƒˆë¡œ ì‹œì‘');
          }
        }
        
        messages.push(chatData);
        console.log('ìƒˆ ë©”ì‹œì§€ ì¶”ê°€ í›„ ì´ ê°œìˆ˜ (ë°©:', chatId || 'general', '):', messages.length + 'ê°œ');
        
        // ìµœëŒ€ 1000ê°œ ë©”ì‹œì§€ë§Œ ì €ì¥ (ë©”ëª¨ë¦¬ ì ˆì•½)
        if (messages.length > 1000) {
          messages = messages.slice(-1000);
          console.log('ë©”ì‹œì§€ ê°œìˆ˜ ì œí•œ ì ìš© (ë°©:', chatId || 'general', '):', messages.length + 'ê°œ');
        }
        
        const encryptedMessages = simpleEncrypt(JSON.stringify(messages), getUserPassword());
        localStorage.setItem(roomKey, encryptedMessages);
        
        console.log('ë©”ì‹œì§€ ì €ì¥ ì™„ë£Œ (ë°©:', chatId || 'general', '):', username, message.substring(0, 20) + '...');
        console.log('localStorage í™•ì¸ (ë°©:', chatId || 'general', '):', localStorage.getItem(roomKey) ? 'ì €ì¥ë¨' : 'ì €ì¥ ì‹¤íŒ¨');
      } catch (error) {
        console.error('ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨:', error);
      }
    }

    function loadChatMessages(chatId = null) {
      try {
        console.log('loadChatMessages í˜¸ì¶œë¨, ë°©ID:', chatId);
        console.log('loadChatMessages - currentChatId:', currentChatId, 'ì „ë‹¬ë°›ì€ chatId:', chatId);
        
        const roomKey = chatId ? `kyberchat_messages_${chatId}` : 'kyberchat_messages_general';
        console.log('loadChatMessages - ì‚¬ìš©í•  roomKey:', roomKey);
        
        const encryptedData = localStorage.getItem(roomKey);
        console.log('localStorageì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„° (ë°©:', chatId || 'general', '):', encryptedData ? 'ìˆìŒ' : 'ì—†ìŒ');
        
        if (!encryptedData) {
          console.log('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (ë°©:', chatId || 'general', ')');
          return [];
        }
        
        const currentPassword = getUserPassword();
        console.log('ì‚¬ìš© ì¤‘ì¸ ë¹„ë°€ë²ˆí˜¸:', currentPassword);
        
        const decryptedData = simpleDecrypt(encryptedData, currentPassword);
        console.log('ë³µí˜¸í™” ê²°ê³¼ (ë°©:', chatId || 'general', '):', decryptedData ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
        
        if (!decryptedData) {
          console.log('ë³µí˜¸í™” ì‹¤íŒ¨, ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ë¡œ ì¬ì‹œë„ (ë°©:', chatId || 'general', ')');
          const fallbackDecrypted = simpleDecrypt(encryptedData, STORAGE_PASSWORD);
          if (fallbackDecrypted) {
            const messages = JSON.parse(fallbackDecrypted);
            console.log('ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³µì› ì„±ê³µ (ë°©:', chatId || 'general', '):', messages.length + 'ê°œ');
            return messages;
          }
          return [];
        }
        
        const messages = JSON.parse(decryptedData);
        console.log('ì €ì¥ëœ ë©”ì‹œì§€ ë¡œë“œ ì„±ê³µ:', messages.length + 'ê°œ');
        return messages;
      } catch (error) {
        console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        return [];
      }
    }

    function clearChatMessages(chatId = null) {
      try {
        const roomKey = chatId ? `kyberchat_messages_${chatId}` : 'kyberchat_messages_general';
        const kyberRoomKey = chatId ? `kyberchat_kyber_${chatId}` : 'kyberchat_kyber_general';
        
        localStorage.removeItem(roomKey);
        localStorage.removeItem(kyberRoomKey);
        console.log('ì €ì¥ëœ ë©”ì‹œì§€ ì‚­ì œ ì™„ë£Œ (ë°©:', chatId || 'general', ')');
      } catch (error) {
        console.error('ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨:', error);
      }
    }

    // ===== ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ =====
    function getUserPassword() {
      return localStorage.getItem(PASSWORD_STORAGE_KEY) || STORAGE_PASSWORD;
    }

    function setUserPassword(password) {
      localStorage.setItem(PASSWORD_STORAGE_KEY, password);
      console.log('ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function clearUserPassword() {
      localStorage.removeItem(PASSWORD_STORAGE_KEY);
      console.log('ë¹„ë°€ë²ˆí˜¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // ===== Kyber í‚¤ ê¸°ë°˜ ë©”ì‹œì§€ ì•”í˜¸í™”/ë³µí˜¸í™” =====
    async function encryptMessageWithKyber(message, peerPublicKey) {
      try {
        if (!peerPublicKey || !myKyber.secretKey) {
          console.warn('Kyber í‚¤ê°€ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ, ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¡œ ì•”í˜¸í™”');
          return simpleEncrypt(message, getUserPassword());
        }
        
        // Kyberë¡œ ë©”ì‹œì§€ ì•”í˜¸í™”
        const encryptedData = await Kyber.encrypt(peerPublicKey, message);
        return bytesToBase64(encryptedData);
      } catch (error) {
        console.error('Kyber ì•”í˜¸í™” ì‹¤íŒ¨:', error);
        // ì‹¤íŒ¨ì‹œ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¡œ ì•”í˜¸í™”
        return simpleEncrypt(message, getUserPassword());
      }
    }

    async function decryptMessageWithKyber(encryptedMessage, mySecretKey) {
      try {
        if (!mySecretKey) {
          console.warn('Kyber ë¹„ë°€í‚¤ê°€ ì—†ìŒ, ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¡œ ë³µí˜¸í™” ì‹œë„');
          return simpleDecrypt(encryptedMessage, getUserPassword());
        }
        
        // Kyberë¡œ ë©”ì‹œì§€ ë³µí˜¸í™”
        const encryptedData = base64ToBytes(encryptedMessage);
        const decryptedMessage = await Kyber.decrypt(encryptedData, mySecretKey);
        return decryptedMessage;
      } catch (error) {
        console.error('Kyber ë³µí˜¸í™” ì‹¤íŒ¨:', error);
        // ì‹¤íŒ¨ì‹œ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¡œ ë³µí˜¸í™”
        return simpleDecrypt(encryptedMessage, getUserPassword());
      }
    }

    async function saveChatMessageWithKyber(message, username, isSender, timestamp, chatId = null) {
      try {
        const roomKey = chatId ? `kyberchat_kyber_${chatId}` : 'kyberchat_kyber_general';
        
        const chatData = {
          message: message,
          username: username,
          isSender: isSender,
          timestamp: timestamp || Date.now()
        };
        
        // Kyber í‚¤ë¡œ ì•”í˜¸í™” (ì‹¤íŒ¨ì‹œ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©)
        const encryptedData = await encryptMessageWithKyber(JSON.stringify(chatData), peerPublicKey);
        const existingData = localStorage.getItem(roomKey);
        let messages = [];
        
        // ê¸°ì¡´ ë°ì´í„° ë³µí˜¸í™”
        if (existingData) {
          try {
            const decryptedData = await decryptMessageWithKyber(existingData, myKyber.secretKey);
            if (decryptedData) {
              messages = JSON.parse(decryptedData);
            }
          } catch (error) {
            console.log('ê¸°ì¡´ Kyber ë°ì´í„° ë³µí˜¸í™” ì‹¤íŒ¨, ìƒˆë¡œ ì‹œì‘:', error);
            messages = [];
          }
        }
        
        messages.push(chatData);
        
        // ìµœëŒ€ 1000ê°œ ë©”ì‹œì§€ë§Œ ì €ì¥ (ë©”ëª¨ë¦¬ ì ˆì•½)
        if (messages.length > 1000) {
          messages = messages.slice(-1000);
        }
        
        // ì „ì²´ ë©”ì‹œì§€ ë°°ì—´ì„ ë‹¤ì‹œ ì•”í˜¸í™”
        const encryptedMessages = await encryptMessageWithKyber(JSON.stringify(messages), peerPublicKey);
        localStorage.setItem(roomKey, encryptedMessages);
        
        console.log('ë©”ì‹œì§€ ì €ì¥ ì™„ë£Œ (Kyber, ë°©:', chatId || 'general', '):', username, message.substring(0, 20) + '...');
      } catch (error) {
        console.error('ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨:', error);
      }
    }

    async function loadChatMessagesWithKyber(chatId = null) {
      try {
        const roomKey = chatId ? `kyberchat_kyber_${chatId}` : 'kyberchat_kyber_general';
        const encryptedData = localStorage.getItem(roomKey);
        if (!encryptedData) return [];
        
        const decryptedData = await decryptMessageWithKyber(encryptedData, myKyber.secretKey);
        if (!decryptedData) return [];
        
        const messages = JSON.parse(decryptedData);
        console.log('ì €ì¥ëœ ë©”ì‹œì§€ ë¡œë“œ (Kyber, ë°©:', chatId || 'general', '):', messages.length + 'ê°œ');
        return messages;
      } catch (error) {
        console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        return [];
      }
    }

    // ===== ì‚¬ìš©ì ì´ë¦„ ê´€ë¦¬ =====
    function saveUsername(username) {
      localStorage.setItem('chatUsername', username);
    }

    function loadUsername() {
      return localStorage.getItem('chatUsername') || '';
    }

    async function connectToChat(username) {
      console.log('connectToChat ì‹œì‘:', username);
      
      currentUsername = username;
      currentUsernameSpan.textContent = currentUsername;
      currentUsernameChatSpan.textContent = currentUsername;
      saveUsername(username);
      
      // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
      usernameModal.style.display = 'none';
      
      // ì‚¬ìš©ì ëª©ë¡ í™”ë©´ í‘œì‹œ
      userListScreen.style.display = 'flex';
      console.log('ì‚¬ìš©ì ëª©ë¡ í™”ë©´ í‘œì‹œë¨');
      
      // ë¨¼ì € Kyber ëª¨ë“ˆ ë¡œë“œ
      try {
        console.log('Kyber ëª¨ë“ˆ ë¡œë”© ì‹œì‘...');
        await Kyber.ready();
        console.log('Kyber ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ');
      } catch (error) {
        console.error('Kyber ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('Kyber ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // WebSocket ì—°ê²°
      console.log('WebSocket ì—°ê²° ì‹œì‘...');
               ws = new WebSocket(`${wsProtocol}://${location.host}`);
      setupWebSocketHandlers();
    }

    // ===== WebSocket í•¸ë“¤ëŸ¬ =====
    function setupWebSocketHandlers() {
      ws.addEventListener('open', () => {
        isConnected = true;
        displaySystemMessage('ì„œë²„ ì—°ê²° ì™„ë£Œ! í‚¤ ìƒì„± ì¤‘...');
        messageInput.disabled = true;
        
        // í‚¤ ìƒì„± (ì§€ì—° ì—†ì´ ì¦‰ì‹œ ì‹¤í–‰)
        generateKyber().catch((error) => {
          console.error('í‚¤ ìƒì„± ì˜¤ë¥˜:', error);
          displaySystemMessage('í‚¤ ìƒì„± ì‹¤íŒ¨: ' + error.message);
        });
      });

      ws.addEventListener('message', async (event) => {
        try {
          const msg = JSON.parse(event.data);
          console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', msg.type);
          
          // ì‚¬ìš©ì ID ìˆ˜ì‹ 
          if (msg.type === 'user_id') {
            currentUserId = msg.userId;
            // userIdë¥¼ localStorageì— ì €ì¥í•˜ì—¬ ë‹¤ìŒ ì ‘ì† ì‹œì—ë„ ìœ ì§€
            localStorage.setItem('kyberchat_user_id', currentUserId);
            console.log('ë‚´ ì‚¬ìš©ì ID ì„¤ì • ë° ì €ì¥ë¨:', currentUserId);
            return;
          }
          
          // ê³µê°œí‚¤ ìˆ˜ì‹ 
          if (msg.type === 'pubkey' && msg.key) {
            console.log('ìƒëŒ€ë°© ê³µê°œí‚¤ ìˆ˜ì‹ , ê¸¸ì´:', msg.key.length);
            peerPublicKey = base64ToBytes(msg.key);
            console.log('peerPublicKey ì„¤ì •ë¨, ë°”ì´íŠ¸ ê¸¸ì´:', peerPublicKey.length);
            
            // ë‚´ í‚¤ë„ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (myKyber.publicKey && myKyber.secretKey) {
              isKeyExchangeComplete = true;
              displaySystemMessage('í‚¤ êµí™˜ ì™„ë£Œ!');
              messageInput.disabled = false;
              messageInput.placeholder = 'ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”...';
              console.log('í‚¤ êµí™˜ ì™„ë£Œ! ë©”ì‹œì§€ ì…ë ¥ ê°€ëŠ¥');
              
            // í‚¤ êµí™˜ ì™„ë£Œ - ë©”ì‹œì§€ ë³µì›ì€ ëŒ€í™”ë°© ì‹œì‘ ì‹œì—ë§Œ ì‹¤í–‰
            console.log('í‚¤ êµí™˜ ì™„ë£Œ - ë©”ì‹œì§€ ë³µì›ì€ ëŒ€í™”ë°© ì‹œì‘ ì‹œì—ë§Œ ì‹¤í–‰');
            } else {
              displaySystemMessage('ìƒëŒ€ë°© ê³µê°œí‚¤ ìˆ˜ì‹ . ë‚´ í‚¤ ìƒì„± ì¤‘...');
              console.log('ë‚´ í‚¤ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ. ëŒ€ê¸° ì¤‘...');
            }
            return;
          }
          
          // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
          if (msg.type === 'user_list_update') {
            console.log('ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸:', msg.users);
            connectedUsers.clear();
            msg.users.forEach(user => {
              connectedUsers.set(user.userId, user);
            });
            updateUserList();
            return;
          }
          
          // ëŒ€í™” ìš”ì²­ ë°›ìŒ
          if (msg.type === 'chat_request') {
            console.log('ëŒ€í™” ìš”ì²­ ë°›ìŒ:', msg);
            currentChatRequest = {
              fromUserId: msg.fromUserId,
              fromUsername: msg.fromUsername,
              requestId: msg.requestId
            };
            
            chatRequestMessage.textContent = `${msg.fromUsername}ë‹˜ì´ ëŒ€í™”ë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.`;
            chatRequestModal.style.display = 'flex';
            return;
          }
          
          // ëŒ€í™” ìš”ì²­ ì „ì†¡ ì™„ë£Œ
          if (msg.type === 'chat_request_sent') {
            displaySystemMessage(msg.message);
            return;
          }
          
          // ëŒ€í™” ìš”ì²­ ê±°ì ˆë¨
          if (msg.type === 'chat_rejected') {
            displaySystemMessage(msg.message);
            return;
          }
          
          // ëŒ€í™” ì‹œì‘ë¨
          if (msg.type === 'chat_started') {
            console.log('ëŒ€í™” ì‹œì‘ë¨:', msg);
            console.log('ì„œë²„ì—ì„œ ë°›ì€ chatId:', msg.chatId);
            selectedUserId = msg.targetUser.userId;
            currentChatId = msg.chatId;
            console.log('ì„¤ì •ëœ currentChatId:', currentChatId);
            isInChat = true;
            
            // ì‚¬ìš©ì ëª©ë¡ í™”ë©´ì—ì„œ ì±„íŒ… í™”ë©´ìœ¼ë¡œ ì „í™˜
            userListScreen.style.display = 'none';
            chatContainer.style.display = 'flex';
            
            // UI ìƒíƒœ í™•ì¸ (ì „í™˜ í›„)
            console.log('ëŒ€í™”ë°© UI ìƒíƒœ í™•ì¸ (ì „í™˜ í›„):');
            console.log('- chatContainer í‘œì‹œ:', chatContainer.style.display);
            console.log('- messageInput ì¡´ì¬:', !!messageInput);
            console.log('- sendButton ì¡´ì¬:', !!sendButton);
            console.log('- sendButton í‘œì‹œ:', sendButton ? sendButton.style.display : 'N/A');
            console.log('- sendButton ë¹„í™œì„±í™”:', sendButton ? sendButton.disabled : 'N/A');
            
            // ì±„íŒ… í—¤ë”ì— ì„ íƒëœ ì‚¬ìš©ì í‘œì‹œ
            document.querySelector('.chat-header h3').textContent = `KyberChat - ${msg.targetUser.username}`;
            
            // ë©”ì‹œì§€ ì…ë ¥ì°½ í™œì„±í™”
            messageInput.disabled = false;
            messageInput.placeholder = `${msg.targetUser.username}ì—ê²Œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...`;
            
            displaySystemMessage(`${msg.targetUser.username}ê³¼ì˜ 1:1 ì±„íŒ…ì„ ì‹œì‘í•©ë‹ˆë‹¤.`);
            
            // âœ… í•´ë‹¹ ë°©ì˜ ë©”ì‹œì§€ ì¦‰ì‹œ ë³µì› (restoreChatHistoryì—ì„œ ì´ˆê¸°í™” ìˆ˜í–‰)
            console.log('ëŒ€í™”ë°© ì‹œì‘ í›„ ë©”ì‹œì§€ ë³µì› ì‹œë„, currentChatId:', currentChatId);
            restoreChatHistory();
            
            return;
          }
          
          // ëŒ€í™” ì¢…ë£Œë¨
          if (msg.type === 'chat_ended') {
            console.log('ëŒ€í™” ì¢…ë£Œë¨');
            selectedUserId = null;
            currentChatId = null;
            isInChat = false;
            
            // âœ… ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            console.log('ëŒ€í™” ì¢…ë£Œ - ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ì™„ë£Œ');
            
            // ì±„íŒ… í™”ë©´ì—ì„œ ì‚¬ìš©ì ëª©ë¡ í™”ë©´ìœ¼ë¡œ ì „í™˜
            chatContainer.style.display = 'none';
            userListScreen.style.display = 'flex';
            
            // ë©”ì‹œì§€ ì…ë ¥ì°½ ë¹„í™œì„±í™”
            messageInput.disabled = true;
            messageInput.placeholder = 'ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”...';
            
            displaySystemMessage('ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            return;
          }
          
          // ëŒ€í™” ì˜¤ë¥˜
          if (msg.type === 'chat_error') {
            displaySystemMessage(msg.message);
            return;
          }
          
          // ì•”í˜¸í™”ëœ ë©”ì‹œì§€ ìˆ˜ì‹ 
          if (msg.type === 'encrypted_message' && msg.encryptedContent) {
            try {
              const encryptedData = base64ToBytes(msg.encryptedContent);
              const decryptedMessage = await Kyber.decrypt(encryptedData, myKyber.secretKey);
              displayMessage(decryptedMessage, false, msg.username || 'ì•Œ ìˆ˜ ì—†ìŒ', true);
            } catch (error) {
              displaySystemMessage('ë³µí˜¸í™” ì‹¤íŒ¨: ' + error.message);
            }
            return;
          }
          
          // í‰ë¬¸ ë©”ì‹œì§€
          if (msg.content) {
            displayMessage(msg.content, false, msg.username || 'ì•Œ ìˆ˜ ì—†ìŒ', true);
          }
        } catch (error) {
          // JSON ì•„ë‹˜ - í‰ë¬¸ìœ¼ë¡œ ì²˜ë¦¬
          if (event.data.length > 2) {
            displayMessage(event.data, false, 'ì•Œ ìˆ˜ ì—†ìŒ', true);
          }
        }
      });

      ws.addEventListener('close', () => {
        isConnected = false;
        displaySystemMessage('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
        console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
      });

      ws.addEventListener('error', (error) => {
        console.error('WebSocket ì˜¤ë¥˜:', error);
        displaySystemMessage('ì—°ê²° ì˜¤ë¥˜ ë°œìƒ');
      });
    }

    // ===== Kyber ê´€ë ¨ í•¨ìˆ˜ =====
    function bytesToBase64(bytes) {
      return btoa(String.fromCharCode(...new Uint8Array(bytes)));
    }

    function base64ToBytes(b64) {
      const bin = atob(b64);
      const bytes = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
      return bytes;
    }

    async function generateKyber() {
      // Kyber.ready()ëŠ” ì´ë¯¸ connectToChat()ì—ì„œ í˜¸ì¶œë¨
      const { publicKey, secretKey } = await Kyber.keypair();
      myKyber.publicKey = publicKey;
      myKyber.secretKey = secretKey;
      console.log('ë‚´ í‚¤ ìƒì„± ì™„ë£Œ. publicKey ê¸¸ì´:', publicKey.length, 'secretKey ê¸¸ì´:', secretKey.length);
      
      // ì €ì¥ëœ userId ê°€ì ¸ì˜¤ê¸° (ìˆìœ¼ë©´ ì¬ì‚¬ìš©)
      const savedUserId = localStorage.getItem('kyberchat_user_id');
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ 
          type: 'pubkey', 
          alg: 'KYBER512', 
          key: bytesToBase64(publicKey),
          username: currentUsername,
          savedUserId: savedUserId // ì €ì¥ëœ userId ì „ì†¡
        }));
        console.log('ë‚´ ê³µê°œí‚¤ ì „ì†¡ ì™„ë£Œ, savedUserId:', savedUserId);
        displaySystemMessage('ê³µê°œí‚¤ ì „ì†¡ ì™„ë£Œ. ìƒëŒ€ë°© ëŒ€ê¸° ì¤‘...');
      }
      
      // ìƒëŒ€ë°© ê³µê°œí‚¤ê°€ ì´ë¯¸ ë„ì°©í–ˆëŠ”ì§€ í™•ì¸
      if (peerPublicKey && peerPublicKey.length > 0) {
        isKeyExchangeComplete = true;
        displaySystemMessage('í‚¤ êµí™˜ ì™„ë£Œ!');
        messageInput.disabled = false;
        messageInput.placeholder = 'ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”...';
        console.log('í‚¤ êµí™˜ ì™„ë£Œ! (ìƒëŒ€ë°© í‚¤ ì´ë¯¸ ìˆ˜ì‹ ë¨)');
        
        // í‚¤ êµí™˜ ì™„ë£Œ - ë©”ì‹œì§€ ë³µì›ì€ ëŒ€í™”ë°© ì‹œì‘ ì‹œì—ë§Œ ì‹¤í–‰
        console.log('í‚¤ êµí™˜ ì™„ë£Œ - ë©”ì‹œì§€ ë³µì›ì€ ëŒ€í™”ë°© ì‹œì‘ ì‹œì—ë§Œ ì‹¤í–‰');
      }
    }

    // ===== ë©”ì‹œì§€ ì „ì†¡ =====
    console.log('sendButton ìš”ì†Œ:', sendButton);
    console.log('sendButtonì´ ì¡´ì¬í•˜ëŠ”ê°€:', !!sendButton);
    
    sendButton.addEventListener('click', async () => {
      const message = messageInput.value.trim();
      console.log('[ë©”ì‹œì§€ ì „ì†¡ ë²„íŠ¼ í´ë¦­] message:', message, 'isKeyExchangeComplete:', isKeyExchangeComplete, 'selectedUserId:', selectedUserId);
      
      if (!message || !isKeyExchangeComplete || !selectedUserId) {
        if (!message) {
          console.log('[ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨] ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìŒ');
        }
        if (!isKeyExchangeComplete) {
          console.log('[ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨] í‚¤ êµí™˜ì´ ì™„ë£Œë˜ì§€ ì•ŠìŒ');
        }
        if (!selectedUserId) {
          console.log('[ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨] ì„ íƒëœ ì‚¬ìš©ìê°€ ì—†ìŒ');
          displaySystemMessage('ë¨¼ì € ëŒ€í™”í•  ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }
        return;
      }
      
      try {
        const targetUser = connectedUsers.get(selectedUserId);
        if (!targetUser) {
          displaySystemMessage('ì„ íƒëœ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // ì„ íƒëœ ì‚¬ìš©ìì˜ ê³µê°œí‚¤ë¡œ ì•”í˜¸í™”
        const targetPublicKey = base64ToBytes(targetUser.publicKey);
        const encryptedData = await Kyber.encrypt(targetPublicKey, message);
        const encryptedBase64 = bytesToBase64(encryptedData);
        
        // ì„ íƒëœ ì‚¬ìš©ìì—ê²Œë§Œ ì „ì†¡
        ws.send(JSON.stringify({ 
          type: 'encrypted_message', 
          username: currentUsername,
          encryptedContent: encryptedBase64,
          targetUserId: selectedUserId
        }));
        
        // í‘œì‹œ
        console.log('[ë©”ì‹œì§€ ì „ì†¡] currentChatId:', currentChatId, 'selectedUserId:', selectedUserId);
        displayMessage(message, true, currentUsername, true);
        messageInput.value = '';
      } catch (error) {
        displaySystemMessage('ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
      }
    });

    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendButton.click();
    });

    // ===== ì•”í˜¸í™”ëœ ë©”ì‹œì§€ í‘œì‹œ =====
    function displayMessageEncrypted(message, isSender = false, username = '') {
      console.log('[displayMessageEncrypted] í˜¸ì¶œë¨');
      
      const messageContainer = document.createElement('div');
      const messageElement = document.createElement('div');
      
      // ì‚¬ìš©ì ì´ë¦„
      if (username && username !== 'ì•Œ ìˆ˜ ì—†ìŒ') {
        const usernameElement = document.createElement('div');
        usernameElement.textContent = username;
        usernameElement.classList.add('message-username');
        messageContainer.appendChild(usernameElement);
      }
      
      messageContainer.classList.add('message-container');
      
      if (isSender) {
        messageContainer.classList.add('sender-message-container');
        messageElement.classList.add('message-bubble', 'sender-message-bubble');
      } else {
        messageElement.classList.add('message-bubble');
      }
      
      // ì•”í˜¸í™”ëœ ìƒíƒœë¡œ í‘œì‹œ
      const encryptedText = 'ğŸ” ' + generateRandomHex(32) + '...';
      messageElement.textContent = encryptedText;
      messageElement.style.fontFamily = 'monospace';
      messageElement.style.fontSize = '12px';
      messageElement.style.color = '#666';
      
      // ì›ë³¸ ë©”ì‹œì§€ ì €ì¥
      originalMessages.set(messageElement, message);
      
      messageContainer.appendChild(messageElement);
      messagesDiv.appendChild(messageContainer);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      // í™”ë©´ì´ ì•”í˜¸í™”ëœ ìƒíƒœì„ì„ í‘œì‹œ
      isScreenEncrypted = true;
      
      console.log('[displayMessageEncrypted] ì•”í˜¸í™”ëœ ë©”ì‹œì§€ í‘œì‹œ ì™„ë£Œ');
    }

    // ===== ë©”ì‹œì§€ í‘œì‹œ =====
    function displayMessage(message, isSender = false, username = '', saveToStorage = true) {
      console.log('[displayMessage] í˜¸ì¶œë¨. isScreenEncrypted:', isScreenEncrypted);
      
      const messageContainer = document.createElement('div');
      const messageElement = document.createElement('div');
      
      // ì‚¬ìš©ì ì´ë¦„
      if (username && username !== 'ì•Œ ìˆ˜ ì—†ìŒ') {
        const usernameElement = document.createElement('div');
        usernameElement.textContent = username;
        usernameElement.classList.add('message-username');
        messageContainer.appendChild(usernameElement);
      }
      
      messageContainer.classList.add('message-container');
      
      if (isSender) {
        messageContainer.classList.add('sender-message-container');
        messageElement.classList.add('message-bubble', 'sender-message-bubble');
      } else {
        messageElement.classList.add('message-bubble');
      }
      
      // í•­ìƒ í‰ë¬¸ìœ¼ë¡œ í‘œì‹œ (ì•”í˜¸í™” ìƒíƒœì™€ ë¬´ê´€)
      messageElement.textContent = message;
      originalMessages.set(messageElement, message);
      
      messageContainer.appendChild(messageElement);
      messagesDiv.appendChild(messageContainer);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      // ë©”ì‹œì§€ë¥¼ ë¡œì»¬ ì €ì¥ì†Œì— Kyber í‚¤ë¡œ ì•”í˜¸í™”í•´ì„œ ì €ì¥
      if (saveToStorage && message && !message.startsWith('ğŸ”')) {
        console.log('[displayMessage] ë©”ì‹œì§€ ì €ì¥ ì‹œ currentChatId:', currentChatId);
        console.log('[displayMessage] ë©”ì‹œì§€ ì €ì¥ ì‹œ selectedUserId:', selectedUserId);
        console.log('[displayMessage] ë©”ì‹œì§€ ì €ì¥ ì‹œ isInChat:', isInChat);
        console.log('[displayMessage] ì €ì¥í•  ë©”ì‹œì§€:', message.substring(0, 20) + '...');
        // ì¦‰ì‹œ ì €ì¥ (Kyber í‚¤ê°€ ì—†ì–´ë„ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ë¡œ ì €ì¥)
        saveChatMessageWithKyber(message, username, isSender, null, currentChatId);
        // ì¶”ê°€ë¡œ ê¸°ë³¸ ë°©ì‹ìœ¼ë¡œë„ ì €ì¥ (ì´ì¤‘ ë°±ì—…)
        saveChatMessage(message, username, isSender, null, currentChatId);
      }
      
      // í™”ë©´ì´ ì•”í˜¸í™”ë˜ì–´ ìˆìœ¼ë©´ ì•”í˜¸í™” ìƒíƒœë¥¼ í•´ì œí•˜ê³  íƒ€ì´ë¨¸ ì¬ì‹œì‘
      if (isScreenEncrypted) {
        console.log('[displayMessage] í™”ë©´ì´ ì•”í˜¸í™”ë¨. ìƒíƒœ í•´ì œí•˜ê³  íƒ€ì´ë¨¸ ì¬ì‹œì‘');
        isScreenEncrypted = false;
      }
      
      // ê¸°ì¡´ íƒ€ì´ë¨¸ë¥¼ ì·¨ì†Œí•˜ê³  ìƒˆë¡œ ì‹œì‘
      if (autoEncryptTimer) {
        console.log('[displayMessage] ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ');
        clearTimeout(autoEncryptTimer);
      }
      
      // 10ì´ˆ í›„ ì „ì²´ ì•”í˜¸í™” (ë³µì›ëœ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
      if (saveToStorage) {
      console.log('[displayMessage] 10ì´ˆ íƒ€ì´ë¨¸ ì‹œì‘');
      startAutoEncryptTimer();
      }
    }

    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ìš”ì†Œ (ì¬ì‚¬ìš©)
    let systemMessageElement = null;
    let systemMessageTimer = null;

    function displaySystemMessage(message) {
      // ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
      if (systemMessageTimer) {
        clearTimeout(systemMessageTimer);
      }
      
      // ê¸°ì¡´ ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ìƒì„±
      if (!systemMessageElement) {
        systemMessageElement = document.createElement('div');
        systemMessageElement.style.textAlign = 'center';
        systemMessageElement.style.color = '#999';
        systemMessageElement.style.fontSize = '12px';
        systemMessageElement.style.margin = '10px 0';
        systemMessageElement.style.transition = 'opacity 0.3s';
        messagesDiv.appendChild(systemMessageElement);
      }
      
      // ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      systemMessageElement.textContent = `ğŸ” ${message}`;
      systemMessageElement.style.opacity = '1';
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      // 3ì´ˆ í›„ í˜ì´ë“œì•„ì›ƒ í›„ ì œê±°
      systemMessageTimer = setTimeout(() => {
        if (systemMessageElement) {
          systemMessageElement.style.opacity = '0';
          setTimeout(() => {
            if (systemMessageElement && systemMessageElement.parentNode) {
              systemMessageElement.parentNode.removeChild(systemMessageElement);
              systemMessageElement = null;
            }
          }, 300);
        }
      }, 3000);
    }

    // ===== ì „ì²´ í™”ë©´ ì•”í˜¸í™”/ë³µí˜¸í™” =====
    function generateRandomHex(length) {
      const chars = '0123456789abcdef';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars[Math.floor(Math.random() * chars.length)];
      }
      return result;
    }

    function encryptAllMessages() {
      console.log('[encryptAllMessages] í˜¸ì¶œë¨. isScreenEncrypted:', isScreenEncrypted);
      if (isScreenEncrypted) {
        console.log('[encryptAllMessages] ì´ë¯¸ ì•”í˜¸í™”ë¨. ì¢…ë£Œ');
        return;
      }
      
      // íƒ€ì´ë¨¸ ì •ë¦¬
      if (autoEncryptTimer) {
        clearTimeout(autoEncryptTimer);
        autoEncryptTimer = null;
      }
      
      // originalMessages.clear()ë¥¼ ì œê±°í•˜ì—¬ ê¸°ì¡´ ë©”ì‹œì§€ ìœ ì§€
      const messageElements = document.querySelectorAll('.message-bubble');
      console.log('[encryptAllMessages] ì•”í˜¸í™”í•  ë©”ì‹œì§€ ìˆ˜:', messageElements.length);
      
      messageElements.forEach((el) => {
        const text = el.textContent;
        if (!text.startsWith('ğŸ”')) {
          // ì•„ì§ originalMessagesì— ì—†ìœ¼ë©´ ì €ì¥
          if (!originalMessages.has(el)) {
            originalMessages.set(el, text);
          }
          el.textContent = 'ğŸ” ' + generateRandomHex(32) + '...';
          el.style.fontFamily = 'monospace';
          el.style.fontSize = '12px';
          el.style.color = '#666';
        }
      });
      
      isScreenEncrypted = true;
      console.log('[encryptAllMessages] ì•”í˜¸í™” ì™„ë£Œ. isScreenEncrypted:', isScreenEncrypted);
    }

    function decryptAllMessages() {
      console.log('[decryptAllMessages] í˜¸ì¶œë¨. isScreenEncrypted:', isScreenEncrypted);
      if (!isScreenEncrypted) {
        console.log('[decryptAllMessages] ì•”í˜¸í™” ì•ˆë¨. ì¢…ë£Œ');
        return;
      }
      
      const messageElements = document.querySelectorAll('.message-bubble');
      console.log('[decryptAllMessages] ë³µí˜¸í™”í•  ë©”ì‹œì§€ ìˆ˜:', messageElements.length);
      
      messageElements.forEach((el) => {
        if (el.textContent.startsWith('ğŸ”')) {
          const original = originalMessages.get(el);
          if (original) {
            el.textContent = original;
            el.style.fontFamily = '';
            el.style.fontSize = '';
            el.style.color = '';
          }
        }
      });
      
      isScreenEncrypted = false;
      console.log('[decryptAllMessages] ë³µí˜¸í™” ì™„ë£Œ. isScreenEncrypted:', isScreenEncrypted);
      
      // ë³µí˜¸í™” í›„ 10ì´ˆ ë’¤ ë‹¤ì‹œ ì•”í˜¸í™”
      console.log('[decryptAllMessages] 10ì´ˆ íƒ€ì´ë¨¸ ì‹œì‘');
      startAutoEncryptTimer();
    }

    function startAutoEncryptTimer() {
      console.log('[startAutoEncryptTimer] í˜¸ì¶œë¨');
      if (autoEncryptTimer) {
        console.log('[startAutoEncryptTimer] ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ');
        clearTimeout(autoEncryptTimer);
      }
      
      autoEncryptTimer = setTimeout(() => {
        console.log('[startAutoEncryptTimer] 10ì´ˆ ê²½ê³¼. isScreenEncrypted:', isScreenEncrypted);
        if (!isScreenEncrypted) {
          encryptAllMessages();
        } else {
          console.log('[startAutoEncryptTimer] ì´ë¯¸ ì•”í˜¸í™”ë¨. ìŠ¤í‚µ');
        }
      }, 10000);
      console.log('[startAutoEncryptTimer] íƒ€ì´ë¨¸ ì„¤ì • ì™„ë£Œ');
    }

    // ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ =====
    // ì•”í˜¸í™”ëœ í™”ë©´ í´ë¦­ ì‹œ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬
    document.addEventListener('click', (event) => {
      if (passwordModal.style.display === 'flex') return;
      
      if ((event.target.closest('.messages-container') || event.target.closest('.message-bubble')) && isScreenEncrypted) {
        passwordModal.style.display = 'flex';
        passwordInput.focus();
      }
    });

    // ë³µí˜¸í™” ë²„íŠ¼
    decryptButton.addEventListener('click', () => {
      if (passwordInput.value === getUserPassword()) {
        decryptAllMessages();
        passwordModal.style.display = 'none';
        passwordInput.value = '';
      } else {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        passwordInput.value = '';
        passwordInput.focus();
      }
    });

    // ì·¨ì†Œ ë²„íŠ¼
    cancelButton.addEventListener('click', () => {
      passwordModal.style.display = 'none';
      passwordInput.value = '';
    });

    // Enter í‚¤
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') decryptButton.click();
    });

    // ESC í‚¤
    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') cancelButton.click();
    });

    // ===== ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ =====
    joinButton.addEventListener('click', () => {
      console.log('ì…ì¥í•˜ê¸° ë²„íŠ¼ í´ë¦­ë¨');
      const username = usernameInput.value.trim();
      console.log('ì…ë ¥ëœ ì‚¬ìš©ì ì´ë¦„:', username);
      
      if (username.length < 2) {
        alert('ì‚¬ìš©ì ì´ë¦„ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      console.log('connectToChat í•¨ìˆ˜ í˜¸ì¶œ');
      connectToChat(username);
    });

    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') joinButton.click();
    });

    changeUsernameButton.addEventListener('click', () => {
      if (confirm('ì´ë¦„ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        usernameModal.style.display = 'flex';
        chatContainer.style.display = 'none';
        usernameInput.value = currentUsername;
        usernameInput.select();
      }
    });

    // ê¸°ë¡ ì‚­ì œ ë²„íŠ¼
    const clearHistoryButton = document.getElementById('clearHistoryButton');
    clearHistoryButton.addEventListener('click', () => {
      const roomName = currentChatId ? `ë°© ${currentChatId}` : 'ì¼ë°˜ ì±„íŒ…';
      if (confirm(`${roomName}ì˜ ëª¨ë“  ì±„íŒ… ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        clearChatMessages(currentChatId);
        messagesDiv.innerHTML = '';
        originalMessages.clear();
        displaySystemMessage(`${roomName}ì˜ ì±„íŒ… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
    });

    // ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ë²„íŠ¼
    const passwordSetupButton = document.getElementById('passwordSetupButton');
    const passwordSetupModal = document.getElementById('passwordSetupModal');
    const newPasswordInput = document.getElementById('newPasswordInput');
    const confirmPasswordInput = document.getElementById('confirmPasswordInput');
    const setPasswordButton = document.getElementById('setPasswordButton');
    const cancelSetupButton = document.getElementById('cancelSetupButton');

    passwordSetupButton.addEventListener('click', () => {
      passwordSetupModal.style.display = 'flex';
      newPasswordInput.focus();
    });

    setPasswordButton.addEventListener('click', () => {
      const newPassword = newPasswordInput.value.trim();
      const confirmPassword = confirmPasswordInput.value.trim();

      if (newPassword.length < 4) {
        alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      setUserPassword(newPassword);
      passwordSetupModal.style.display = 'none';
      newPasswordInput.value = '';
      confirmPasswordInput.value = '';
      displaySystemMessage('ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    cancelSetupButton.addEventListener('click', () => {
      passwordSetupModal.style.display = 'none';
      newPasswordInput.value = '';
      confirmPasswordInput.value = '';
    });

    // ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ëª¨ë‹¬ì—ì„œ Enter í‚¤ ì²˜ë¦¬
    newPasswordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') confirmPasswordInput.focus();
    });

    confirmPasswordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') setPasswordButton.click();
    });

    // ===== ì €ì¥ëœ ë©”ì‹œì§€ ë³µì› =====
    async function restoreChatHistory() {
      try {
        // í˜„ì¬ ì±„íŒ…ë°©ì´ ì—†ìœ¼ë©´ ë³µì›í•˜ì§€ ì•ŠìŒ
        if (!currentChatId) {
          console.log('í˜„ì¬ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤. ë³µì›í•˜ì§€ ì•ŠìŒ. currentChatId:', currentChatId);
          return;
        }
        
        // ì´ë¯¸ ë³µì› ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        if (isRestoringHistory) {
          console.log('ë©”ì‹œì§€ ë³µì›ì´ ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€.');
          return;
        }
        
        console.log('=== ë©”ì‹œì§€ ë³µì› ì‹œì‘ (ë°©:', currentChatId, ') ===');
        
        // âœ… ê°€ì¥ ë¨¼ì € ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ì™„ì „ ì´ˆê¸°í™”
        messagesDiv.innerHTML = '';
        originalMessages.clear();
        console.log('âœ… ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ì™„ì „ ì´ˆê¸°í™” ì™„ë£Œ');
        
        isRestoringHistory = true;
        
        console.log('í˜„ì¬ localStorage ìƒíƒœ:', localStorage.length + 'ê°œ í•­ëª©');
        console.log('currentChatId ê°’:', currentChatId);
        
        // localStorageì˜ ëª¨ë“  í‚¤ í™•ì¸
        console.log('localStorage í‚¤ë“¤:');
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.includes('kyberchat')) {
            console.log('  -', key, ':', localStorage.getItem(key) ? 'ë°ì´í„° ìˆìŒ' : 'ë°ì´í„° ì—†ìŒ');
          }
        }
        
        // ë¨¼ì € ê¸°ë³¸ ì•”í˜¸í™” ë°©ì‹ìœ¼ë¡œ ì‹œë„
        const savedMessages = loadChatMessages(currentChatId);
        console.log('loadChatMessages ê²°ê³¼:', savedMessages.length + 'ê°œ ë©”ì‹œì§€');
        
        if (savedMessages.length > 0) {
          console.log('ì €ì¥ëœ ì±„íŒ… ê¸°ë¡ ë³µì› ì¤‘...', savedMessages.length + 'ê°œ');
          
          // ì €ì¥ëœ ë©”ì‹œì§€ë“¤ì„ ì•”í˜¸í™”ëœ ìƒíƒœë¡œ í‘œì‹œ
          savedMessages.forEach((msg, index) => {
            console.log(`ë©”ì‹œì§€ ${index + 1} ë³µì›:`, msg.username, msg.message.substring(0, 20) + '...');
            displayMessageEncrypted(msg.message, msg.isSender, msg.username); // ì•”í˜¸í™”ëœ ìƒíƒœë¡œ í‘œì‹œ
          });
          
          // ë³µì› ì™„ë£Œ ë©”ì‹œì§€
          displaySystemMessage(`${savedMessages.length}ê°œì˜ ì €ì¥ëœ ë©”ì‹œì§€ë¥¼ ë³µì›í–ˆìŠµë‹ˆë‹¤. (ì•”í˜¸í™”ë¨)`);
          console.log('=== ë©”ì‹œì§€ ë³µì› ì™„ë£Œ ===');
          isRestoringHistory = false; // ë³µì› ì™„ë£Œ í”Œë˜ê·¸ í•´ì œ
          return;
        }
        
        console.log('ê¸°ë³¸ ë°©ì‹ìœ¼ë¡œ ë³µì› ì‹¤íŒ¨, Kyber ë°©ì‹ ì‹œë„');
        
        // Kyber í‚¤ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸° í›„ ì‹œë„
        let attempts = 0;
        while ((!myKyber.secretKey || !peerPublicKey) && attempts < 100) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }
        
        console.log('Kyber í‚¤ ìƒíƒœ:', {
          mySecretKey: myKyber.secretKey ? 'ìˆìŒ' : 'ì—†ìŒ',
          peerPublicKey: peerPublicKey ? 'ìˆìŒ' : 'ì—†ìŒ',
          attempts: attempts
        });
        
        if (myKyber.secretKey && peerPublicKey) {
          console.log('Kyber í‚¤ ì¤€ë¹„ë¨, Kyber ì•”í˜¸í™” ë°©ì‹ìœ¼ë¡œ ë³µì› ì‹œë„');
          const kyberMessages = await loadChatMessagesWithKyber(currentChatId);
          if (kyberMessages.length > 0) {
            console.log('ì €ì¥ëœ ì±„íŒ… ê¸°ë¡ ë³µì› ì¤‘ (Kyber)...', kyberMessages.length + 'ê°œ');
            
            // ê¸°ì¡´ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
            messagesDiv.innerHTML = '';
            originalMessages.clear();
            
            // ì €ì¥ëœ ë©”ì‹œì§€ë“¤ì„ ì•”í˜¸í™”ëœ ìƒíƒœë¡œ í‘œì‹œ
            kyberMessages.forEach((msg, index) => {
              console.log(`Kyber ë©”ì‹œì§€ ${index + 1} ë³µì›:`, msg.username, msg.message.substring(0, 20) + '...');
              displayMessageEncrypted(msg.message, msg.isSender, msg.username); // ì•”í˜¸í™”ëœ ìƒíƒœë¡œ í‘œì‹œ
            });
            
            // ë³µì› ì™„ë£Œ ë©”ì‹œì§€
            displaySystemMessage(`${kyberMessages.length}ê°œì˜ ì €ì¥ëœ ë©”ì‹œì§€ë¥¼ ë³µì›í–ˆìŠµë‹ˆë‹¤. (Kyber ì•”í˜¸í™”ë¨)`);
            console.log('=== Kyber ë©”ì‹œì§€ ë³µì› ì™„ë£Œ ===');
          } else {
            console.log('Kyber ë°©ì‹ìœ¼ë¡œë„ ë³µì›í•  ë©”ì‹œì§€ê°€ ì—†ìŒ');
          }
        } else {
          console.log('Kyber í‚¤ê°€ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ, ë³µì› ì‹¤íŒ¨');
        }
        
        isRestoringHistory = false; // ë³µì› ì™„ë£Œ í”Œë˜ê·¸ í•´ì œ
      } catch (error) {
        console.error('ë©”ì‹œì§€ ë³µì› ì‹¤íŒ¨:', error);
        isRestoringHistory = false; // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ í”Œë˜ê·¸ í•´ì œ
      }
    }


    // ===== localStorage ë””ë²„ê¹… =====
    function debugLocalStorage() {
      console.log('=== localStorage ë””ë²„ê¹… ===');
      console.log('localStorage ì´ í•­ëª© ìˆ˜:', localStorage.length);
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        console.log(`í‚¤ ${i}:`, key);
        if (key && key.includes('kyberchat')) {
          const value = localStorage.getItem(key);
          console.log(`ê°’ ê¸¸ì´:`, value ? value.length : 0);
        }
      }
      console.log('=== ë””ë²„ê¹… ì™„ë£Œ ===');
    }

    // ===== ì´ˆê¸°í™” ===== (ì²« ë²ˆì§¸ load ì´ë²¤íŠ¸ - ì œê±°ë¨, ì•„ë˜ ë‘ ë²ˆì§¸ ê²ƒë§Œ ì‚¬ìš©)

    // ===== ì‚¬ìš©ì ëª©ë¡ ê´€ë¦¬ =====
    function updateUserList() {
      try {
        console.log('[updateUserList] ì‹¤í–‰ë¨, ì—°ê²°ëœ ì‚¬ìš©ì ìˆ˜:', connectedUsers.size);
      
      // ëª¨ë‹¬ ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
      if (!userList) {
        console.error('userList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
      }
      
      if (connectedUsers.size === 0) {
        userList.innerHTML = '<div class="no-users">ì ‘ì†í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        userList.innerHTML = '';
        connectedUsers.forEach((user, userId) => {
          if (userId === currentUserId || user.username === currentUsername) return; // ìì‹ ì€ ëª©ë¡ì—ì„œ ì œì™¸
          
          const userItem = document.createElement('div');
          userItem.className = 'user-item';
          userItem.dataset.userId = userId;
          
          const userInfo = document.createElement('div');
          userInfo.className = 'user-info';
          
          const avatar = document.createElement('div');
          avatar.className = 'user-avatar';
          avatar.textContent = user.username.charAt(0).toUpperCase();
          
          const name = document.createElement('div');
          name.className = 'user-name';
          name.textContent = user.username;
          
          const status = document.createElement('div');
          status.className = 'user-status';
          if (user.inChat) {
            status.textContent = 'ëŒ€í™” ì¤‘';
            status.style.color = '#ff6b6b';
          } else {
            status.textContent = 'ì˜¨ë¼ì¸';
            status.style.color = '#28a745';
          }
          
          userInfo.appendChild(avatar);
          userInfo.appendChild(name);
          userInfo.appendChild(status);
          
          const selectButton = document.createElement('button');
          selectButton.className = 'select-button';
          selectButton.textContent = selectedUserId === userId ? 'ì„ íƒë¨' : 'ì„ íƒ';
          
          userItem.appendChild(userInfo);
          userItem.appendChild(selectButton);
          
          userItem.addEventListener('click', () => {
            selectUser(userId);
          });
          
          userList.appendChild(userItem);
        });
      }
      
      // ë©”ì¸ ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
      console.log('[updateUserList] updateMainUserList í˜¸ì¶œ ì‹œì‘');
      updateMainUserList();
      console.log('[updateUserList] updateMainUserList í˜¸ì¶œ ì™„ë£Œ');
      } catch (error) {
        console.error('[updateUserList] í•¨ìˆ˜ì—ì„œ ì˜¤ë¥˜ ë°œìƒ:', error);
      }
    }

    function updateMainUserList() {
      console.log('[updateMainUserList] ì‹¤í–‰ë¨, ì—°ê²°ëœ ì‚¬ìš©ì ìˆ˜:', connectedUsers.size);
      const mainUserList = document.getElementById('mainUserList');
      
      if (!mainUserList) {
        console.error('mainUserList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
      }
      
      console.log('mainUserList ìš”ì†Œ ì°¾ìŒ:', mainUserList);
      
      if (connectedUsers.size === 0) {
        console.log('ì‚¬ìš©ìê°€ ì—†ì–´ì„œ "ì ‘ì†í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤" í‘œì‹œ');
        mainUserList.innerHTML = '<div class="no-users">ì ‘ì†í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      mainUserList.innerHTML = '';
      console.log('ì‚¬ìš©ì ëª©ë¡ ìƒì„± ì‹œì‘, ì´ ì‚¬ìš©ì ìˆ˜:', connectedUsers.size);
      let addedUsers = 0;
      
      connectedUsers.forEach((user, userId) => {
        console.log(`ì‚¬ìš©ì í™•ì¸: ${user.username} (${userId}), í˜„ì¬ ì‚¬ìš©ì: ${currentUsername} (${currentUserId})`);
        if (userId === currentUserId || user.username === currentUsername) {
          console.log('ìì‹ ì€ ëª©ë¡ì—ì„œ ì œì™¸:', user.username);
          return; // ìì‹ ì€ ëª©ë¡ì—ì„œ ì œì™¸
        }
        
        const userItem = document.createElement('div');
        userItem.className = 'main-user-item';
        userItem.dataset.userId = userId;
        
        if (user.inChat) {
          userItem.classList.add('disabled');
        }
        
        const userInfo = document.createElement('div');
        userInfo.className = 'main-user-info';
        
        const avatar = document.createElement('div');
        avatar.className = 'main-user-avatar';
        avatar.textContent = user.username.charAt(0).toUpperCase();
        
        const details = document.createElement('div');
        details.className = 'main-user-details';
        
        const name = document.createElement('div');
        name.className = 'main-user-name';
        name.textContent = user.username;
        
        const status = document.createElement('div');
        status.className = 'main-user-status';
        if (user.inChat) {
          status.textContent = 'ëŒ€í™” ì¤‘';
          status.classList.add('busy');
        } else {
          status.textContent = 'ì˜¨ë¼ì¸';
          status.classList.add('online');
        }
        
        details.appendChild(name);
        details.appendChild(status);
        
        userInfo.appendChild(avatar);
        userInfo.appendChild(details);
        
        const chatButton = document.createElement('button');
        chatButton.className = 'main-chat-button';
        chatButton.textContent = 'ì±„íŒ…í•˜ê¸°';
        chatButton.disabled = user.inChat;
        
        userItem.appendChild(userInfo);
        userItem.appendChild(chatButton);
        
        userItem.addEventListener('click', () => {
          if (!user.inChat) {
            selectUser(userId);
          }
        });
        
        console.log(`ì‚¬ìš©ì ì•„ì´í…œ ì¶”ê°€: ${user.username} (${userId})`);
        mainUserList.appendChild(userItem);
        addedUsers++;
      });
      
      console.log(`ì‚¬ìš©ì ëª©ë¡ ìƒì„± ì™„ë£Œ, ì¶”ê°€ëœ ì‚¬ìš©ì ìˆ˜: ${addedUsers}`);
    }

    function selectUser(userId) {
      console.log('[selectUser] ì‚¬ìš©ì ì„ íƒ:', userId);
      
      const user = connectedUsers.get(userId);
      if (!user) {
        displaySystemMessage('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ì´ë¯¸ ëŒ€í™” ì¤‘ì¸ ì‚¬ìš©ìì¸ì§€ í™•ì¸
      if (user.inChat) {
        displaySystemMessage(`${user.username}ì€ ì´ë¯¸ ë‹¤ë¥¸ ì‚¬ìš©ìì™€ ëŒ€í™” ì¤‘ì…ë‹ˆë‹¤.`);
        return;
      }
      
      // í˜„ì¬ ì‚¬ìš©ìê°€ ì´ë¯¸ ëŒ€í™” ì¤‘ì¸ì§€ í™•ì¸
      if (isInChat) {
        displaySystemMessage('ì´ë¯¸ ë‹¤ë¥¸ ì‚¬ìš©ìì™€ ëŒ€í™” ì¤‘ì…ë‹ˆë‹¤.');
        return;
      }
      
      // ëŒ€í™” ìš”ì²­ ì „ì†¡
      ws.send(JSON.stringify({
        type: 'request_chat',
        targetUserId: userId
      }));
      
      displaySystemMessage(`${user.username}ì—ê²Œ ëŒ€í™” ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
    }

    function addUser(userId, username, publicKey) {
      console.log('[addUser] ì‚¬ìš©ì ì¶”ê°€:', userId, username);
      connectedUsers.set(userId, { username, publicKey, connected: true });
      updateUserList();
    }

    function removeUser(userId) {
      console.log('[removeUser] ì‚¬ìš©ì ì œê±°:', userId);
      connectedUsers.delete(userId);
      updateUserList();
      
      if (selectedUserId === userId) {
        selectedUserId = null;
        document.querySelector('.chat-header h3').textContent = 'KyberChat';
        messageInput.placeholder = 'ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”...';
        messageInput.disabled = true;
        displaySystemMessage('ì„ íƒëœ ì‚¬ìš©ìê°€ ì—°ê²°ì„ ëŠì—ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ëŒ€í™” ì¢…ë£Œ ë²„íŠ¼ ì¶”ê°€/ì œê±°
    function addEndChatButton() {
      const userInfo = document.querySelector('.user-info');
      const existingButton = document.getElementById('endChatButton');
      
      if (!existingButton) {
        const endChatButton = document.createElement('button');
        endChatButton.id = 'endChatButton';
        endChatButton.textContent = 'ëŒ€í™” ì¢…ë£Œ';
        endChatButton.style.background = '#ff6b6b';
        endChatButton.style.color = 'white';
        endChatButton.style.marginLeft = '8px';
        endChatButton.style.border = 'none';
        endChatButton.style.padding = '6px 12px';
        endChatButton.style.borderRadius = '4px';
        endChatButton.style.cursor = 'pointer';
        endChatButton.style.fontSize = '12px';
        
        endChatButton.addEventListener('click', () => {
          ws.send(JSON.stringify({
            type: 'end_chat'
          }));
        });
        
        userInfo.appendChild(endChatButton);
      }
    }

    function removeEndChatButton() {
      const endChatButton = document.getElementById('endChatButton');
      if (endChatButton) {
        endChatButton.remove();
      }
    }

    // ëŒ€í™” ìš”ì²­ ìˆ˜ë½/ê±°ì ˆ ë²„íŠ¼
    acceptChatButton.addEventListener('click', () => {
      if (currentChatRequest) {
        ws.send(JSON.stringify({
          type: 'accept_chat',
          requestId: currentChatRequest.requestId,
          fromUserId: currentChatRequest.fromUserId
        }));
        
        chatRequestModal.style.display = 'none';
        currentChatRequest = null;
      }
    });
    
    rejectChatButton.addEventListener('click', () => {
      if (currentChatRequest) {
        ws.send(JSON.stringify({
          type: 'reject_chat',
          fromUserId: currentChatRequest.fromUserId
        }));
        
        chatRequestModal.style.display = 'none';
        currentChatRequest = null;
        displaySystemMessage('ëŒ€í™” ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ì‚¬ìš©ì ëª©ë¡ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
    if (userListButton) {
      userListButton.addEventListener('click', () => {
        if (isInChat) {
          displaySystemMessage('í˜„ì¬ ëŒ€í™”ë¥¼ ì¢…ë£Œí•œ í›„ ë‹¤ë¥¸ ì‚¬ìš©ìë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          return;
        }
        userListModal.style.display = 'flex';
        updateUserList();
      });
    }

    closeUserList.addEventListener('click', () => {
      userListModal.style.display = 'none';
    });

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    userListModal.addEventListener('click', (e) => {
      if (e.target === userListModal) {
        userListModal.style.display = 'none';
      }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('load', () => {
      console.log('=== í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ===');
      
      // localStorage ë””ë²„ê¹… (í•„ìš”ì‹œ)
      // debugLocalStorage();
      
      // ì €ì¥ëœ ì‚¬ìš©ì ì´ë¦„ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì—°ê²°
      const savedUsername = loadUsername();
      
      if (savedUsername && savedUsername.length >= 2) {
        console.log('ì €ì¥ëœ ì‚¬ìš©ì ì´ë¦„ìœ¼ë¡œ ìë™ ì—°ê²°:', savedUsername);
        connectToChat(savedUsername);
      } else {
        console.log('ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ');
        usernameModal.style.display = 'flex';
      }
    });
  </script>
</body>
</html>

